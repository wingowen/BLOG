<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Kubernetes | WINGO BLOG</title>
  <meta name="description" content="Docker 没有很好地解决容器的集群问题，Kubernetes 抓住了这个机遇，以容器编排者 Container Orchestration 的身份出现，对容器集群进行管理和调度。K8s 内部还是需要 Docker 的，但它的功能范围被大大压缩了，只是负责底层的容器引擎和镜像 Docker Image 管理，成为了容器体系中不可缺少,，但没有存在感的一部分，而绝大部分的对外接口都是由 k8s 来">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes">
<meta property="og:url" content="https://wingowen.github.io/2022/04/15/Kubernetes/index.html">
<meta property="og:site_name" content="WINGO&#39;S BLOG">
<meta property="og:description" content="Docker 没有很好地解决容器的集群问题，Kubernetes 抓住了这个机遇，以容器编排者 Container Orchestration 的身份出现，对容器集群进行管理和调度。K8s 内部还是需要 Docker 的，但它的功能范围被大大压缩了，只是负责底层的容器引擎和镜像 Docker Image 管理，成为了容器体系中不可缺少,，但没有存在感的一部分，而绝大部分的对外接口都是由 k8s 来">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-04-15T01:06:13.000Z">
<meta property="article:modified_time" content="2022-05-12T10:01:20.901Z">
<meta property="article:author" content="Wingo Wen">
<meta property="article:tag" content="K8S">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="https://wingowen.github.io/2022/04/15/Kubernetes/index.html">
  
  
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 6.2.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">WINGO WEN</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
      </ul>
      
    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>得失从缘，心无增减</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BigData/" rel="tag">BigData</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/English/" rel="tag">English</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8S/" rel="tag">K8S</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%80%83%E7%A0%94/" rel="tag">考研</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">7</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2022/05/01/%E5%A4%A9%E6%B1%A0/" class="title">天池</a>
              </p>
              <p class="item-date">
                <time datetime="2022-05-01T08:34:36.000Z" itemprop="datePublished">2022-05-01</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2022/04/25/The-Economist/" class="title">The Economist</a>
              </p>
              <p class="item-date">
                <time datetime="2022-04-25T01:49:27.000Z" itemprop="datePublished">2022-04-25</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2022/04/21/%E8%80%83%E7%A0%94/" class="title">考研</a>
              </p>
              <p class="item-date">
                <time datetime="2022-04-21T06:19:23.000Z" itemprop="datePublished">2022-04-21</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2022/04/21/Python/" class="title">Python</a>
              </p>
              <p class="item-date">
                <time datetime="2022-04-21T03:30:00.000Z" itemprop="datePublished">2022-04-21</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2022/04/15/Kubernetes/" class="title">Kubernetes</a>
              </p>
              <p class="item-date">
                <time datetime="2022-04-15T01:06:13.000Z" itemprop="datePublished">2022-04-15</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2"><span class="toc-number">1.</span> <span class="toc-text">安装部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Minikube"><span class="toc-number">1.1.</span> <span class="toc-text">Minikube</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RBAC"><span class="toc-number">2.</span> <span class="toc-text">RBAC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#kind"><span class="toc-number">2.1.</span> <span class="toc-text">kind</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#KubeFate"><span class="toc-number">3.</span> <span class="toc-text">KubeFate</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#rbac-yaml"><span class="toc-number">3.1.</span> <span class="toc-text">rbac.yaml</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ingress-nginx"><span class="toc-number">4.</span> <span class="toc-text">Ingress-nginx</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DashBoard"><span class="toc-number">5.</span> <span class="toc-text">DashBoard</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Kubernetes" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Kubernetes
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2022/04/15/Kubernetes/" class="article-date">
	  <time datetime="2022-04-15T01:06:13.000Z" itemprop="datePublished">2022-04-15</time>
	</a>
</span>
        
        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/K8S/" rel="tag">K8S</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/04/15/Kubernetes/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>Docker 没有很好地解决容器的集群问题，Kubernetes 抓住了这个机遇，以容器编排者 Container Orchestration 的身份出现，对容器集群进行管理和调度。K8s 内部还是需要 Docker 的，但它的功能范围被大大压缩了，只是负责底层的容器引擎和镜像 Docker Image 管理，成为了容器体系中不可缺少,，但没有存在感的一部分，而绝大部分的对外接口都是由 k8s 来负责。</p>
<p>k8s 的一切都是对象 Object，它的核心概念一共只有 4 个：Pod、部署 Deployment、服务 Service 和节点 Node。另外再加上一个容器镜像 Docker Image，这个是 Docker 引擎的核心。掌握了这五个核心概念，就对容器技术有了基本了解，打下了扎实的基础。</p>
<p><strong>Pod</strong></p>
<p>Pod 是 k8s 最基本概念，你可以把它看成是对容器 container 的一个封装，用来管理容器。一个 Pod 里可以管理有一个或多个容器，但一般是一个。Pod 里的所有容器都共享 Pod 的资源和网络。当一个 Pod 不能满足用户需求时，你可以把 Pod 作为复制的最小单元来复制出一个同样的 Pod 来处理用户请求。Pod 支持多种容器，不过一般是用Docker。你可以用单独的Pod配置文件创建Pod, 也可以把Pod的配置信息放在其他的对象（例如Deployment）的配置文件里面，并与其他对象一起创建，后者更为常见。每一个Pod都有一个唯一的IP地址，Pod一旦生成就可以通过IP地址进行访问。但一般不这么做，而是通过服务（Service）去间接地去访问。下面就是Pod的配置文件。它的解释放在后面的Deployment里面。</p>
<p>不可变基础设施：Pod</p>
<p>Pod 由一个或多个容器组成，不可分割，作为一个整体运行在一个 Node 节点上。是用户在 K8S 中能够操作的最小的原子化单位。</p>
<p>Pod 中的容器共享网络、存储资源。（文件交换、本地通信、PRC 调用）</p>
<p>容器其实是一个单进程的模型</p>
<p>Pod 是 Kubernetes 项目中实现“容器设计模式”的最佳实践之一，也是 Kubernetes 进行复杂应用编排的基础依赖。</p>
<p>Probe 探针：livenessProbe readinessProbe startupProbe</p>
<p>Pod 中的健康检查 Handler：ExecAction HttpGetAction TcpSocketAction</p>
<p>容器生命周期中的 hook：PostStart PreStop</p>
<p>init 容器：检测前置资源和环境是否符合要求。</p>
<p>Pod 使用后就会被杀掉，单个 Pod 无法保证服务的高可用，通过副本 Replica 来保证 Pod 的可用数量，避免业务不可用</p>
<p>无状态工作负载：</p>
<p>Deployment 高级抽象</p>
<p>label 用于匹配</p>
<p>默认</p>
<p>有状态</p>
<p>常用工具</p>
<ul>
<li>kubeadm：初始化集群的指令；</li>
<li>kubelet：在集群中的每个节点上用来启动 Pod 和容器等；</li>
<li>kubectl：集群通信命令行工具。</li>
</ul>
<p>Kubernetes 集群包括两种类型资源：</p>
<ul>
<li><p>Master 节点：协调控制整个集群。Master 负责集群的管理。Master 协调集群中的所有行为 &#x2F; 活动，例如应用的运行、修改、更新等。</p>
</li>
<li><p>Nodes 节点：运行应用的工作节点，可以是 VM 虚拟机、物理机。每个 node 上都有一个Kubelet，用于管理 node 节点与 Kubernetes Master 通信。每个 Node 节点上至少还要运行 container runtime，比如 docker 或者 rkt。</p>
</li>
</ul>
<h1 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h1><p>docker</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">yum list docker-ce --showduplicates | sort -r</span><br><span class="line">yum install docker-ce-</span><br><span class="line"></span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>kubeadm</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"># vi /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes Repository</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">yum install -y kubelet-1.23.0-0.x86_64 kubeadm-1.23.0-0.x86_64 kubectl-1.23.0-0.x86_64 --disableexcludes=kubernetes</span><br><span class="line"></span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl enable kubelet</span><br><span class="line"></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"></span><br><span class="line"># 禁用 SELINUX：</span><br><span class="line">setenforce 0</span><br><span class="line">vi /etc/selinux/config</span><br><span class="line">SELINUX=disabled</span><br><span class="line"># 创建/etc/sysctl.d/k8s.conf文件，添加如下内容：</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"># 执行如下命令使修改生效</span><br><span class="line">modprobe br_netfilter</span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line"></span><br><span class="line"># 需保证 docker 和 kubelet 的的 cgroupdriver 是相同的</span><br><span class="line"># vi /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;],</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">imageRepository=registry.aliyuncs.com/google_containers</span><br><span class="line"></span><br><span class="line"># Master 机器操作</span><br><span class="line">kubeadm config print init-defaults &gt; init-config.yaml</span><br><span class="line">kubeadm config images pull --config=init-config.yaml</span><br><span class="line">kubeadm init --config=init-config.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 复制配置文件，否则 get nodes 会报错：refused</span><br><span class="line">cd ~</span><br><span class="line">mkdir .kube</span><br><span class="line">cp /ect/kubernetes/admin.conf config</span><br><span class="line"></span><br><span class="line"># WORKER 机器操作</span><br><span class="line">kubeadm config print join-defaults &gt; join-config.yaml</span><br><span class="line">kubeadm config images pull --config=join-config.yaml</span><br><span class="line">kubeadm join --config=init-config.yaml</span><br><span class="line"></span><br><span class="line"># apiServerEndpoint 的值来自 Master 服务器的地址，token 和 tlsBootstrapToken 的值就来自于使用 kubeadm init 安装 Master 的最后一行提示信息。</span><br><span class="line"></span><br><span class="line"># 网络插件 weave</span><br><span class="line">kubectl apply -f &quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d &#x27;\n&#x27;)&quot; </span><br><span class="line"></span><br><span class="line"># 查看报错信息</span><br><span class="line">kubectl --namespace=kube-system describe pod&lt;pod_name&gt;</span><br><span class="line"></span><br><span class="line"># 主机恢复原状</span><br><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure>

<p><strong>常用命令</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 对资源进行配置，如果资源不存在，将会新建一个。</span><br><span class="line">kubectl apply -f FILENAME</span><br></pre></td></tr></table></figure>

<p><strong>流程描述</strong></p>
<p>Deployment 等 Controller 会通过动态创建和销毁 Pod 来保证应用整体的健壮性。</p>
<p>Pod 是脆弱的，但应用是健壮的，所以每一次销毁重建 Pod 时，Pod 对应的 Ip 地址都会发生变化，Kubernetes 针对这个问题给出的解决方案就是使用 Service 来访问 Pod。</p>
<h2 id="Minikube"><a href="#Minikube" class="headerlink" title="Minikube"></a>Minikube</h2><p>Minikube 可以实现一种轻量级的 Kubernetes 集群，通过在本地计算机上创建虚拟机并部署只包含单个节点的简单集群。</p>
<h1 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h1><p>Role-Based Access Control 基于角色的访问控制。</p>
<p>四个顶级类型</p>
<ul>
<li>Role</li>
<li>ClusterRole</li>
<li>RoleBinding</li>
<li>ClusterRoleBinding</li>
</ul>
<p>角色可以用 Role 来定义到某个命名空间 namespace 上， 或者用 ClusterRole 来定义到整个集群作用域，即所有 namespace。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-reader</span><br><span class="line">  namespace: default</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;] # &quot;&quot; 指定核心 API 组</span><br><span class="line">  resources: [&quot;pods&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</span><br></pre></td></tr></table></figure>

<h2 id="kind"><a href="#kind" class="headerlink" title="kind"></a>kind</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl api-resource -o wide --namespac=true</span><br><span class="line">kubectl api-resource -o wide --namespac=false</span><br></pre></td></tr></table></figure>

<h1 id="KubeFate"><a href="#KubeFate" class="headerlink" title="KubeFate"></a>KubeFate</h1><p>Kubernetes: <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/releases/tag/v1.23.5">v1.23.5</a></p>
<p>Ingress-nginx: <a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx/releases/tag/controller-v1.1.3">v1.1.3</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;192.168.35.133 example.com&quot; &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<h2 id="rbac-yaml"><a href="#rbac-yaml" class="headerlink" title="rbac.yaml"></a>rbac.yaml</h2><p>ServiceAccount 是一种账号，给运行在 Pod 里面的进程提供必要的身份证明。</p>
<p>RoleBinding、ClusterRoleBinding 绑定的 Subject 对象可以是 User、Group、Service Account。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-fate</span><br><span class="line">  labels:</span><br><span class="line">    name: kube-fate</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: kubefate-admin</span><br><span class="line">  namespace: kube-fate</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubefate</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: kubefate-role</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: kubefate-admin</span><br><span class="line">    namespace: kube-fate</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: kubefate-secret</span><br><span class="line">  namespace: kube-fate</span><br><span class="line">type: Opaque</span><br><span class="line">stringData:</span><br><span class="line">  kubefateUsername: admin</span><br><span class="line">  kubefatePassword: admin</span><br><span class="line">  mariadbUsername: kubefate</span><br><span class="line">  mariadbPassword: kubefate</span><br><span class="line">---</span><br><span class="line">apiVersion: policy/v1beta1</span><br><span class="line">kind: PodSecurityPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: kubefate-psp</span><br><span class="line">  namespace: kube-fate</span><br><span class="line">spec:</span><br><span class="line">  privileged: false</span><br><span class="line">  seLinux:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  supplementalGroups:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  runAsUser:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  fsGroup:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  volumes:</span><br><span class="line">  - &#x27;*&#x27;</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: kubefate-role</span><br><span class="line">  namespace: kube-fate</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - namespaces</span><br><span class="line">  - configmaps</span><br><span class="line">  - services</span><br><span class="line">  - secrets</span><br><span class="line">  - persistentvolumeclaims</span><br><span class="line">  - serviceaccounts</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - update</span><br><span class="line">  - patch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  - pods/log</span><br><span class="line">  - nodes</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">- apiGroups:</span><br><span class="line">  - apps</span><br><span class="line">  resources:</span><br><span class="line">  - deployments</span><br><span class="line">  - statefulsets</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - update</span><br><span class="line">  - patch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - update</span><br><span class="line">  - patch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.istio.io</span><br><span class="line">  resources:</span><br><span class="line">  - gateway</span><br><span class="line">  - virtualservice</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - update</span><br><span class="line">  - patch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - policy</span><br><span class="line">  resources:</span><br><span class="line">  - podsecuritypolicies</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - use</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - update</span><br><span class="line">  - patch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - rbac.authorization.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - roles</span><br><span class="line">  - rolebindings</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - create</span><br><span class="line">  - delete</span><br><span class="line">  - update</span><br><span class="line">  - patch</span><br></pre></td></tr></table></figure>

<h1 id="Ingress-nginx"><a href="#Ingress-nginx" class="headerlink" title="Ingress-nginx"></a>Ingress-nginx</h1><p>访问 Ingress 的三种方式:</p>
<p>Pod 使用宿主机的 IP，设置 hostNetwork: true，不需要 Service;</p>
<p>ingress-nginx 的 Service 使用 NodePort 方式，也就是与宿主机映射;</p>
<p>在公有云上部署，购买公有云的 SLB 对接 ingress-service，ingress-service 的 service 设置成 LoadBalance。</p>
<h1 id="DashBoard"><a href="#DashBoard" class="headerlink" title="DashBoard"></a>DashBoard</h1><p>1.8+ 后资源使用指标通过 Metrics API 在 K8S 中获取。</p>
<p><strong>部署 Metrics Server</strong></p>
<ul>
<li>k8s kubeadm 安装；</li>
<li>Metrics Server v0.3.2 版本；</li>
<li>k8s 证书存放在 &#x2F;opt&#x2F;kubernetes&#x2F;ssl 目录下；</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.6/components.yaml</span><br></pre></td></tr></table></figure>






      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://wingowen.github.io/2022/04/15/Kubernetes/" title="Kubernetes" target="_blank" rel="external">https://wingowen.github.io/2022/04/15/Kubernetes/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">WINGO WEN</span><small class="ml-1x"></small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2022/04/21/Python/" title="Python"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2022/04/07/Docker/" title="Docker"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">    <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   






</body>
</html>