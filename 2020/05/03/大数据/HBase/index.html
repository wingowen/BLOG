<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Hbase | WINGO BLOG</title>
  <meta name="description" content="HBase 的简本介绍及简使用。">
<meta property="og:type" content="article">
<meta property="og:title" content="Hbase">
<meta property="og:url" content="https://wingowen.github.io/2020/05/03/%E5%A4%A7%E6%95%B0%E6%8D%AE/HBase/index.html">
<meta property="og:site_name" content="WINGO&#39;S BLOG">
<meta property="og:description" content="HBase 的简本介绍及简使用。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wingowen.github.io/img//2020/05/HBase/HBase01.jpg">
<meta property="og:image" content="https://wingowen.github.io/img//2020/05/HBase/HBase02.jpg">
<meta property="og:image" content="https://wingowen.github.io/img//2020/05/HBase/HBase03.jpg">
<meta property="og:image" content="https://wingowen.github.io/img//2020/05/HBase/HBase04.jpg">
<meta property="og:image" content="https://wingowen.github.io/img//2020/05/HBase/HBase05.jpg">
<meta property="og:image" content="https://wingowen.github.io/img//2020/05/HBase/HBase06.jpg">
<meta property="og:image" content="https://wingowen.github.io/img//2020/05/HBase/HBase07.jpg">
<meta property="og:image" content="https://wingowen.github.io/img//2020/05/HBase/HBase08.jpg">
<meta property="og:image" content="https://wingowen.github.io/img//2020/05/HBase/HBase09.jpg">
<meta property="article:published_time" content="2020-05-03T00:41:00.000Z">
<meta property="article:modified_time" content="2023-09-20T07:35:51.828Z">
<meta property="article:author" content="Wingo Wen">
<meta property="article:tag" content="HBase">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wingowen.github.io/img//2020/05/HBase/HBase01.jpg">
  <!-- Canonical links -->
  <link rel="canonical" href="https://wingowen.github.io/2020/05/03/%E5%A4%A7%E6%95%B0%E6%8D%AE/HBase/index.html">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="WINGO'S BLOG" type="application/atom+xml">
</head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">WINGO.WEN</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
      </ul>
      
    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>得失从缘 心无增减</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9F%BA%E7%A1%80%E7%A7%91%E5%AD%A6/">基础科学</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E9%A1%B9/">杂项</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/">计算机科学</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a><span class="category-list-count">5</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Aysnc/" style="font-size: 13px;">Aysnc</a> <a href="/tags/Cache/" style="font-size: 13px;">Cache</a> <a href="/tags/Druid/" style="font-size: 13px;">Druid</a> <a href="/tags/Dubbo/" style="font-size: 13px;">Dubbo</a> <a href="/tags/ElasticSearch/" style="font-size: 13px;">ElasticSearch</a> <a href="/tags/Email/" style="font-size: 13px;">Email</a> <a href="/tags/Flume/" style="font-size: 13px;">Flume</a> <a href="/tags/Git/" style="font-size: 13px;">Git</a> <a href="/tags/HBase/" style="font-size: 13px;">HBase</a> <a href="/tags/Hadoop/" style="font-size: 13px;">Hadoop</a> <a href="/tags/Hive/" style="font-size: 13.25px;">Hive</a> <a href="/tags/Impala/" style="font-size: 13px;">Impala</a> <a href="/tags/InooDB/" style="font-size: 13px;">InooDB</a> <a href="/tags/JDBC/" style="font-size: 13px;">JDBC</a> <a href="/tags/JPA/" style="font-size: 13px;">JPA</a> <a href="/tags/Kafka/" style="font-size: 13px;">Kafka</a> <a href="/tags/Kudu/" style="font-size: 13px;">Kudu</a> <a href="/tags/Linux/" style="font-size: 13px;">Linux</a> <a href="/tags/Log/" style="font-size: 13px;">Log</a> <a href="/tags/MQ/" style="font-size: 13.25px;">MQ</a> <a href="/tags/MyBatis/" style="font-size: 13px;">MyBatis</a> <a href="/tags/MySQL/" style="font-size: 13px;">MySQL</a> <a href="/tags/Netty/" style="font-size: 14px;">Netty</a> <a href="/tags/Pandas/" style="font-size: 13px;">Pandas</a> <a href="/tags/SQL/" style="font-size: 13px;">SQL</a> <a href="/tags/Scheduled/" style="font-size: 13px;">Scheduled</a> <a href="/tags/Security/" style="font-size: 13px;">Security</a> <a href="/tags/Shiro/" style="font-size: 13px;">Shiro</a> <a href="/tags/Spring-Boot/" style="font-size: 14px;">Spring Boot</a> <a href="/tags/Web/" style="font-size: 13px;">Web</a> <a href="/tags/WebSocket/" style="font-size: 13px;">WebSocket</a> <a href="/tags/demo/" style="font-size: 13.5px;">demo</a> <a href="/tags/gRPC/" style="font-size: 13px;">gRPC</a> <a href="/tags/peewee/" style="font-size: 13px;">peewee</a> <a href="/tags/sklearn/" style="font-size: 13px;">sklearn</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 13px;">爬虫</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 13.75px;">算法</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 13px;">网络</a> <a href="/tags/%E8%80%83%E7%A0%94/" style="font-size: 13.75px;">考研</a> <a href="/tags/%E8%84%9A%E6%9C%AC%E5%91%BD%E4%BB%A4/" style="font-size: 13px;">脚本命令</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 13px;">设计模式</a> <a href="/tags/%E9%83%A8%E7%BD%B2/" style="font-size: 13px;">部署</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">九月 2023</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">9</span></li></ul>
    </div>
  </div>


    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text"> 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.1.</span> <span class="toc-text"> 数据模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text"> 基本架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2"><span class="toc-number">1.3.</span> <span class="toc-text"> 安装部署</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shell"><span class="toc-number">2.</span> <span class="toc-text"> Shell</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">2.1.</span> <span class="toc-text"> 基本操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A8%E6%93%8D%E4%BD%9C"><span class="toc-number">2.2.</span> <span class="toc-text"> 表操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6"><span class="toc-number">3.</span> <span class="toc-text"> 进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%8E%9F%E7%90%86"><span class="toc-number">3.1.</span> <span class="toc-text"> 结构原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E6%B5%81%E7%A8%8B"><span class="toc-number">3.2.</span> <span class="toc-text"> 写流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memstore-flush"><span class="toc-number">3.3.</span> <span class="toc-text"> MemStore Flush</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">3.4.</span> <span class="toc-text"> 读流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#storefile-compaction"><span class="toc-number">3.5.</span> <span class="toc-text"> StoreFile Compaction</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#region-split"><span class="toc-number">3.6.</span> <span class="toc-text"> Region Split</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#api"><span class="toc-number">4.</span> <span class="toc-text"> API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A8%E6%93%8D%E4%BD%9C-2"><span class="toc-number">4.1.</span> <span class="toc-text"> 表操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mapreduce"><span class="toc-number">4.2.</span> <span class="toc-text"> MapReduce</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E6%A1%88%E4%BE%8B"><span class="toc-number">4.2.1.</span> <span class="toc-text"> 官方案例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89"><span class="toc-number">4.2.2.</span> <span class="toc-text"> 自定义</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90-hive"><span class="toc-number">5.</span> <span class="toc-text"> 集成 Hive</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text"> 优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">6.1.</span> <span class="toc-text"> 高可用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E5%88%86%E5%8C%BA"><span class="toc-number">6.2.</span> <span class="toc-text"> 预分区</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rowkey"><span class="toc-number">6.3.</span> <span class="toc-text"> RowKey</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">6.4.</span> <span class="toc-text"> 内存优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98"><span class="toc-number">7.</span> <span class="toc-text"> 项目实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A8%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="toc-number">7.1.</span> <span class="toc-text"> 表的创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.2.</span> <span class="toc-text"> 功能实现</span></a></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-大数据/HBase" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Hbase
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2020/05/03/%E5%A4%A7%E6%95%B0%E6%8D%AE/HBase/" class="article-date">
	  <time datetime="2020-05-03T00:41:00.000Z" itemprop="datePublished">2020-05-03</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/HBase/" rel="tag">HBase</a>
  </span>


        

        <!-- <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/05/03/%E5%A4%A7%E6%95%B0%E6%8D%AE/HBase/#comments" class="article-comment-link">评论</a></span> -->
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>HBase 的简本介绍及简使用。</p>
<span id="more"></span>
<h3 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h3>
<p>HBase 是一种分布式、可扩展、支持海量数据存储的 NoSQL 数据库。</p>
<p>逻辑上，HBase 的数据模型同关系型数据库很类似，数据存储在一张表中，有行有列。 但从 HBase 的底层物理存储结构（K-V）来看，HBase 更像是一个 multi-dimensional map。</p>
<img src="/img//2020/05/HBase/HBase01.jpg" style="zoom: 80%;" />
<h4 id="数据模型"><a class="markdownIt-Anchor" href="#数据模型"></a> 数据模型</h4>
<p><strong>Name Space</strong></p>
<p>命名空间，类似于关系型数据库的 DatabBase 概念，每个命名空间下有多个表。HBase 有两个自带的命名空间，分别是 hbase 和 default，hbase 中存放的是 HBase 内置的表， default 表是用户默认使用的命名空间。</p>
<p><strong>Region</strong></p>
<p>类似于关系型数据库的表概念。不同的是，HBase 定义表时只需要声明列族即可，不需 要声明具体的列。这意味着，往 HBase 写入数据时，字段可以动态、按需指定。因此，和关 系型数据库相比，HBase 能够轻松应对字段变更的场景。</p>
<p><strong>Row</strong></p>
<p>HBase 表中的每行数据都由一个 RowKey 和多个 Column（列）组成，数据是按照 RowKey 的字典顺序存储的，并且查询数据时只能根据 RowKey 进行检索，所以 RowKey 的设计十分重 要。</p>
<p><strong>Column</strong></p>
<p>HBase 中的每个列都由 (Column Family) 列族 和 (Column Qualifier )列限定符进行限 定，例如 info：name，info：age。建表时，只需指明列族，而列限定符无需预先定义。</p>
<p><strong>Time Stamp</strong></p>
<p>用于标识数据的不同版本（version），每条数据写入时，如果不指定时间戳，系统会自动为其加上该字段，其值为写入 HBase 的时间。</p>
<p><strong>Cell</strong></p>
<p>由 {RowKey, Column Family：Column Qualifier, Time Stamp} 唯一确定的单元。cell 中的数据是没有类型的，全部是字节码形式存贮。</p>
<h4 id="基本架构"><a class="markdownIt-Anchor" href="#基本架构"></a> 基本架构</h4>
<p><img src="/img//2020/05/HBase/HBase02.jpg" alt="" /></p>
<p><strong>Region Server</strong></p>
<p>Region Server 为 Region 的管理者，其实现类为 HRegionServer，主要作用如下：对于数据的操作：get, put, delete； 对于 Region 的操作：splitRegion、compactRegion。</p>
<p><strong>Master</strong></p>
<p>Master 是所有 Region Server 的管理者，其实现类为 HMaster，主要作用如下： 对于表的操作：create, delete, alter；对于 RegionServer的操作：分配 regions 到每个RegionServer，监控每个 RegionServer 的状态，负载均衡和故障转移。</p>
<p><strong>Zookeeper</strong></p>
<p>HBase 通过 Zookeeper 来做 Master 的高可用、RegionServer 的监控、元数据的入口以及集群配置的维护等工作。</p>
<p><strong>HDFS</strong></p>
<p>HDFS 为 HBase 提供最终的底层数据存储服务，同时为 HBase 提供高可用的支持。</p>
<h4 id="安装部署"><a class="markdownIt-Anchor" href="#安装部署"></a> 安装部署</h4>
<blockquote>
<p>首先要保证 Zookeeper 集群和 Hadoop 集群正常部署并启动。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf hbase-1.3.1-bin.tar.gz -C /opt/module</span><br><span class="line">vi hbase-env.sh </span><br><span class="line">	export JAVA_HOME=/opt/module/jdk1.6.0_144</span><br><span class="line">	export HBASE_MANAGES_ZK=false # 关闭自带的 Zookeeper</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 修改 hbase-site.xml 配置文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://hadoop102:9000/HBase<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 0.98 后的新变动，之前版本没有.port,默认端口为 60000 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.master.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>16000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- region servers --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop102,hadoop103,hadoop104<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.property.dataDir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/module/zookeeper-3.4.10/zkData<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">软连接 hadoop 配置文件到 HBase</span></span><br><span class="line">ln -s /opt/module/hadoop2.7.2/etc/hadoop/core-site.xml /opt/module/hbase/conf/core-site.xml</span><br><span class="line">ln -s /opt/module/hadoop2.7.2/etc/hadoop/hdfs-site.xml /opt/module/hbase/conf/hdfs-site.xml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">利用脚本发送到其它集群</span></span><br><span class="line"> xsync hbase/</span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">时间同步，否则会导致 regionserver 无法启动，抛出 ClockOutOfSyncException 异常</span></span><br><span class="line"> bin/start-hbase.sh</span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">可通过 16010 端口访问 HBase 管理页面</span></span><br></pre></td></tr></table></figure>
<h3 id="shell"><a class="markdownIt-Anchor" href="#shell"></a> Shell</h3>
<h4 id="基本操作"><a class="markdownIt-Anchor" href="#基本操作"></a> 基本操作</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入 HBase 客户端命令行</span></span><br><span class="line">bin/hbase shell</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看帮助命令</span></span><br><span class="line">hbase(main):001:0&gt; help</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前数据库中有哪些表</span> </span><br><span class="line">hbase(main):002:0&gt; list</span><br></pre></td></tr></table></figure>
<h4 id="表操作"><a class="markdownIt-Anchor" href="#表操作"></a> 表操作</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建表，只需要初始化一个列族信息即可</span></span><br><span class="line">hbase(main):002:0&gt; create &#x27;student&#x27;,&#x27;info&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">插入数据到表</span> </span><br><span class="line">hbase(main):003:0&gt; put &#x27;student&#x27;,&#x27;1001&#x27;,&#x27;info:sex&#x27;,&#x27;male&#x27;</span><br><span class="line">hbase(main):004:0&gt; put &#x27;student&#x27;,&#x27;1001&#x27;,&#x27;info:age&#x27;,&#x27;18&#x27;</span><br><span class="line">hbase(main):005:0&gt; put &#x27;student&#x27;,&#x27;1002&#x27;,&#x27;info:name&#x27;,&#x27;Janna&#x27;</span><br><span class="line">hbase(main):006:0&gt; put &#x27;student&#x27;,&#x27;1002&#x27;,&#x27;info:sex&#x27;,&#x27;female&#x27;</span><br><span class="line">hbase(main):007:0&gt; put &#x27;student&#x27;,&#x27;1002&#x27;,&#x27;info:age&#x27;,&#x27;20&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">扫描查看表数据</span></span><br><span class="line">hbase(main):008:0&gt; scan &#x27;student&#x27;</span><br><span class="line">hbase(main):009:0&gt; scan &#x27;student&#x27;,&#123;STARTROW=&gt;&#x27;1001&#x27;, STOPROW=&gt;&#x27;1001&#x27;&#125;</span><br><span class="line">hbase(main):010:0&gt; scan &#x27;student&#x27;,&#123;STARTROW=&gt;&#x27;1001&#x27;&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看表结构</span></span><br><span class="line">hbase(main):011:0&gt; describe ‘student’</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新指定字段的数据</span></span><br><span class="line">hbase(main):012:0&gt; put &#x27;student&#x27;,&#x27;1001&#x27;,&#x27;info:name&#x27;,&#x27;Nick&#x27;</span><br><span class="line">hbase(main):013:0&gt; put &#x27;student&#x27;,&#x27;1001&#x27;,&#x27;info:age&#x27;,&#x27;100&#x27;</span><br><span class="line">hbase(main):014:0&gt; get &#x27;student&#x27;,&#x27;1001&#x27;</span><br><span class="line">hbase(main):015:0&gt; get &#x27;student&#x27;,&#x27;1001&#x27;,&#x27;info:name&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">统计表数据行数</span></span><br><span class="line">hbase(main):021:0&gt; count &#x27;student&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除数据</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除某 rowkey 的全部数据</span></span><br><span class="line">hbase(main):016:0&gt; deleteall &#x27;student&#x27;,&#x27;1001&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除某 rowkey 的某一列数据</span></span><br><span class="line">hbase(main):017:0&gt; delete &#x27;student&#x27;,&#x27;1002&#x27;,&#x27;info:sex&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清空表数据</span></span><br><span class="line">hbase(main):018:0&gt; truncate &#x27;student&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除表 需要先让该表为 <span class="built_in">disable</span> 状态</span></span><br><span class="line">hbase(main):019:0&gt; disable &#x27;student&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">然后才能 drop 这个表</span></span><br><span class="line">hbase(main):020:0&gt; drop &#x27;student&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">变更表信息 将 info 列族中的数据存放 3 个版本</span></span><br><span class="line">hbase(main):022:0&gt; alter &#x27;student&#x27;,&#123;NAME=&gt;&#x27;info&#x27;,VERSIONS=&gt;3&#125;</span><br><span class="line">hbase(main):022:0&gt; get &#x27;student&#x27;,&#x27;1001&#x27;,&#123;COLUMN=&gt;&#x27;info:name&#x27;,VERSIONS=&gt;3&#125;</span><br></pre></td></tr></table></figure>
<h3 id="进阶"><a class="markdownIt-Anchor" href="#进阶"></a> 进阶</h3>
<h4 id="结构原理"><a class="markdownIt-Anchor" href="#结构原理"></a> 结构原理</h4>
<p><img src="/img//2020/05/HBase/HBase03.jpg" alt="" /></p>
<p><strong>StoreFile</strong></p>
<p>保存实际数据的物理文件，StoreFile 以 HFile 的形式存储在 HDFS 上。每个 Store 会有 一个或多个 StoreFile（HFile），数据在每个 StoreFile 中都是有序的。</p>
<p><strong>MemStore</strong></p>
<p>写缓存，由于 HFile 中的数据要求是有序的，所以数据是先存储在 MemStore 中，排好序后，等到达刷写时机才会刷写到 HFile，每次刷写都会形成一个新的 HFile。</p>
<p><strong>WAL</strong> Write-Ahead Logging</p>
<p>由于数据要经 MemStore 排序后才能刷写到 HFile，但把数据保存在内存中会有很高的概率导致数据丢失，为了解决这个问题，数据会先写在一个叫做 Write-Ahead logfile 的文件 中，然后再写入 MemStore 中。所以在系统出现故障的时候，数据可以通过这个日志文件重建。</p>
<h4 id="写流程"><a class="markdownIt-Anchor" href="#写流程"></a> 写流程</h4>
<p><img src="/img//2020/05/HBase/HBase04.jpg" alt="" /></p>
<ol>
<li>Client 先访问 zookeeper，获取 hbase:meta 表位于哪个 Region Server；</li>
<li>访问对应的 Region Server，获取 hbase:meta 表，根据写请求的 namespace:table/rowkey， 查询出目标数据位于哪个 Region Server 中的哪个 Region 中。并将该 table 的 region 信息以 及 meta 表的位置信息缓存在客户端的 meta cache，方便下次访问；</li>
<li>与目标 Region Server 进行通讯；</li>
<li>将数据顺序写入（追加）到 WAL；</li>
<li>将数据写入对应的 MemStore，数据会在 MemStore 进行排序；</li>
<li>向客户端发送 ack；</li>
<li>等达到 MemStore 的刷写时机后，将数据刷写到 HFile。</li>
</ol>
<h4 id="memstore-flush"><a class="markdownIt-Anchor" href="#memstore-flush"></a> MemStore Flush</h4>
<img src="/img//2020/05/HBase/HBase05.jpg" style="zoom:67%;" />
<p>刷写时机</p>
<ol>
<li>当某个 memstroe 的大小达到了 hbase.hregion.memstore.flush.size（默认值 128M）， 其所在 region 的所有 memstore 都会刷写。 当 memstore 的大小达到了 hbase.hregion.memstore.flush.size（默认值 128M） * hbase.hregion.memstore.block.multiplier（默认值 4） 时，会阻止继续往该 memstore 写数据。</li>
<li>当 region server 中 memstore 的总大小达到 java_heapsize * hbase.regionserver.global.memstore.size（默认值 0.4）* hbase.regionserver.global.memstore.size.lower.limit（默认值 0.95）， region 会按照其所有 memstore 的大小顺序（由大到小）依次进行刷写。直到 region server 中所有 memstore 的总大小减小到上述值以下。 当 region server 中 memstore 的总大小达到 java_heapsize * hbase.regionserver.global.memstore.size（默认值 0.4） 时，会阻止继续往所有的 memstore 写数据。</li>
<li>到达自动刷写的时间，也会触发 memstore flush。自动刷新的时间间隔由该属性进行配置，官方建议关闭此配置，hbase.regionserver.optionalcacheflushinterval（默认 1 小时）。</li>
<li>当 WAL 文件的数量超过 hbase.regionserver.max.logs，region 会按照时间顺序依次进行刷写，直到 WAL 文件数量减小到 hbase.regionserver.max.log 以下（该属性名已经废弃， 现无需手动设置，最大值为 32）。</li>
</ol>
<h4 id="读流程"><a class="markdownIt-Anchor" href="#读流程"></a> 读流程</h4>
<p><img src="/img//2020/05/HBase/HBase06.jpg" alt="" /></p>
<ol>
<li>Client 先访问 zookeeper，获取 hbase:meta 表位于哪个 Region Server；</li>
<li>访问对应的 Region Server，获取 hbase:meta 表，根据读请求的 namespace:table/rowkey， 查询出目标数据位于哪个 Region Server 中的哪个 Region 中。并将该 table 的 region 信息以 及 meta 表的位置信息缓存在客户端的 meta cache，方便下次访问；</li>
<li>与目标 Region Server 进行通讯；</li>
<li>分别在 Block Cache（读缓存），MemStore 和 Store File（HFile）中查询目标数据，并将查到的所有数据进行合并。此处所有数据是指同一条数据的不同版本（time stamp）或者不同的类型（Put / Delete）；</li>
<li>将从文件中查询到的数据块（Block，HFile 数据存储单元，默认大小为 64KB）缓存到 Block Cache；</li>
<li>将合并后的最终结果返回给客户端。</li>
</ol>
<h4 id="storefile-compaction"><a class="markdownIt-Anchor" href="#storefile-compaction"></a> StoreFile Compaction</h4>
<p>由于 memstore 每次刷写都会生成一个新的 HFile，且同一个字段的不同版本（timestamp） 和不同类型（Put / Delete）有可能会分布在不同的 HFile 中，因此查询时需要遍历所有的 HFile。为了减少 HFile 的个数，以及清理掉过期和删除的数据，会进行 StoreFile Compaction。</p>
<p>Compaction 分为两种，分别是 Minor Compaction 和 Major Compaction。</p>
<p>Minor Compaction 会将临近的若干个较小的 HFile 合并成一个较大的 HFile，但不会清理过期和删除的数据。<br />
Major Compaction 会将一个 Store 下的所有的 HFile 合并成一个大 HFile，并且会清理掉过期 和删除的数据。</p>
<p><img src="/img//2020/05/HBase/HBase07.jpg" alt="" /></p>
<h4 id="region-split"><a class="markdownIt-Anchor" href="#region-split"></a> Region Split</h4>
<p>默认情况下，每个 Table 起初只有一个 Region，随着数据的不断写入，Region 会自动进行拆分。刚拆分时，两个子 Region 都位于当前的 Region Server，但处于负载均衡的考虑， HMaster 有可能会将某个 Region 转移给其他的 Region Server。</p>
<p>Region Split 时机：</p>
<ol>
<li>.当1个region中的某个 Store 下所有 StoreFile 的总大小超过 hbase.hregion.max.filesize， 该 Region 就会进行拆分（0.94 版本之前）。</li>
<li>当 1 个 region 中 的 某 个 Store 下所有 StoreFile 的 总 大 小 超 过<br />
Min(R^2 * “hbase.hregion.memstore.flush.size”,hbase.hregion.max.filesize&quot;)，该 Region 就会进行拆分，其 中 R 为当前 Region Server 中属于该 Table 的个数（0.94 版本之后）。</li>
</ol>
<img src="/img//2020/05/HBase/HBase08.jpg" style="zoom: 67%;" />
<h3 id="api"><a class="markdownIt-Anchor" href="#api"></a> API</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取 Configuration 对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Configuration conf;</span><br><span class="line"><span class="keyword">static</span>&#123;</span><br><span class="line">    <span class="comment">// 使用 HBaseConfiguration 的单例方法实例化</span></span><br><span class="line">    conf = HBaseConfiguration.create();</span><br><span class="line">    <span class="comment">// 只需要配置 Zookeeper 的信息，因为 mate 都存在 Zookeeper 中</span></span><br><span class="line">    conf.set(<span class="string">&quot;hbase.zookeeper.quorum&quot;</span>, <span class="string">&quot;192.166.9.102&quot;</span>);</span><br><span class="line">    conf.set(<span class="string">&quot;hbase.zookeeper.property.clientPort&quot;</span>, <span class="string">&quot;2181&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="表操作-2"><a class="markdownIt-Anchor" href="#表操作-2"></a> 表操作</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断表石是否存在</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isTableExist</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> </span><br><span class="line">    MasterNotRunningException,ZooKeeperConnectionException, IOException&#123;</span><br><span class="line">    <span class="comment">// 在 HBase 中管理、访问表需要先创建 HBaseAdmin 对象</span></span><br><span class="line">    ConnectionFactory.createConnection(conf);</span><br><span class="line">    <span class="type">HBaseAdmin</span> <span class="variable">admin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HBaseAdmin</span>(conf);</span><br><span class="line">    <span class="keyword">return</span> admin.tableExists(tableName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建表</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createTable</span><span class="params">(String tableName, String... columnFamily)</span> <span class="keyword">throws</span></span><br><span class="line">    MasterNotRunningException, ZooKeeperConnectionException, IOException&#123;</span><br><span class="line">    <span class="type">HBaseAdmin</span> <span class="variable">admin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HBaseAdmin</span>(conf);</span><br><span class="line">    <span class="comment">// 判断表是否存在</span></span><br><span class="line">    <span class="keyword">if</span>(isTableExist(tableName))&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;表&quot;</span> + tableName + <span class="string">&quot;已存在&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 创建表属性对象，表名需要转字节</span></span><br><span class="line">        <span class="type">HTableDescriptor</span> <span class="variable">descriptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HTableDescriptor</span>(TableName.valueOf(tableName));</span><br><span class="line">        <span class="comment">// 创建多个列族</span></span><br><span class="line">        <span class="keyword">for</span>(String cf : columnFamily)&#123;</span><br><span class="line">            descriptor.addFamily(<span class="keyword">new</span> <span class="title class_">HColumnDescriptor</span>(cf));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据对表的配置，创建表</span></span><br><span class="line">        admin.createTable(descriptor);</span><br><span class="line">        System.out.println(<span class="string">&quot;表&quot;</span> + tableName + <span class="string">&quot;创建成功！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除表</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dropTable</span><span class="params">(String tableName)</span> <span class="keyword">throws</span></span><br><span class="line">    MasterNotRunningException, ZooKeeperConnectionException, IOException&#123;</span><br><span class="line">    <span class="type">HBaseAdmin</span> <span class="variable">admin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HBaseAdmin</span>(conf);</span><br><span class="line">    <span class="keyword">if</span>(isTableExist(tableName))&#123;</span><br><span class="line">        admin.disableTable(tableName);</span><br><span class="line">        admin.deleteTable(tableName);</span><br><span class="line">        System.out.println(<span class="string">&quot;表&quot;</span> + tableName + <span class="string">&quot;删除成功！&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;表&quot;</span> + tableName + <span class="string">&quot;不存在！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向表中插入数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addRowData</span><span class="params">(</span></span><br><span class="line"><span class="params">    String tableName, String rowKey, String columnFamily, String column, String value)</span> </span><br><span class="line">    <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="comment">// 创建 HTable 对象</span></span><br><span class="line">    <span class="type">HTable</span> <span class="variable">hTable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HTable</span>(conf, tableName);</span><br><span class="line">    <span class="comment">// 向表中插入数据</span></span><br><span class="line">    <span class="type">Put</span> <span class="variable">put</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Put</span>(Bytes.toBytes(rowKey));</span><br><span class="line">    <span class="comment">// 向 Put 对象中组装数据</span></span><br><span class="line">    put.add(Bytes.toBytes(columnFamily), Bytes.toBytes(column),</span><br><span class="line">            Bytes.toBytes(value));</span><br><span class="line">    hTable.put(put);</span><br><span class="line">    hTable.close();</span><br><span class="line">    System.out.println(<span class="string">&quot;插入数据成功&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除多行数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deleteMultiRow</span><span class="params">(String tableName, String... rows)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="type">HTable</span> <span class="variable">hTable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HTable</span>(conf, tableName);</span><br><span class="line">    List&lt;Delete&gt; deleteList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Delete&gt;();</span><br><span class="line">    <span class="keyword">for</span>(String row : rows)&#123;</span><br><span class="line">        <span class="type">Delete</span> <span class="variable">delete</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Delete</span>(Bytes.toBytes(row));</span><br><span class="line">        deleteList.add(delete);</span><br><span class="line">    &#125;</span><br><span class="line">    hTable.delete(deleteList);</span><br><span class="line">    hTable.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取所有数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getAllRows</span><span class="params">(String tableName)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="type">HTable</span> <span class="variable">hTable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HTable</span>(conf, tableName);</span><br><span class="line">    <span class="comment">// 得到用于扫描 region 的对象</span></span><br><span class="line">    <span class="type">Scan</span> <span class="variable">scan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scan</span>();</span><br><span class="line">    <span class="comment">// 使用 HTable 得到 resultcanner 实现类的对象</span></span><br><span class="line">    <span class="type">ResultScanner</span> <span class="variable">resultScanner</span> <span class="operator">=</span> hTable.getScanner(scan);</span><br><span class="line">    <span class="keyword">for</span>(Result result : resultScanner)&#123;</span><br><span class="line">        <span class="comment">// 获取单元</span></span><br><span class="line">        Cell[] cells = result.rawCells();</span><br><span class="line">        <span class="keyword">for</span>(Cell cell : cells)&#123;</span><br><span class="line">            <span class="comment">//得到 rowkey</span></span><br><span class="line">            System.out.println(<span class="string">&quot; 行 键 :&quot;</span> + Bytes.toString(CellUtil.cloneRow(cell)));</span><br><span class="line">            <span class="comment">//得到列族</span></span><br><span class="line">            System.out.println(<span class="string">&quot; 列 族 &quot;</span> + Bytes.toString(CellUtil.cloneFamily(cell)));</span><br><span class="line">            System.out.println(<span class="string">&quot; 列 :&quot;</span> + Bytes.toString(CellUtil.cloneQualifier(cell)));</span><br><span class="line">            System.out.println(<span class="string">&quot; 值 :&quot;</span> + Bytes.toString(CellUtil.cloneValue(cell)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取某一行数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getRow</span><span class="params">(String tableName, String rowKey)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="type">HTable</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HTable</span>(conf, tableName);</span><br><span class="line">    <span class="type">Get</span> <span class="variable">get</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Get</span>(Bytes.toBytes(rowKey));</span><br><span class="line">    <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> table.get(get);</span><br><span class="line">    <span class="keyword">for</span>(Cell cell : result.rawCells())&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot; 行 键 :&quot;</span> + Bytes.toString(result.getRow()));</span><br><span class="line">        System.out.println(<span class="string">&quot; 列 族 &quot;</span> + Bytes.toString(CellUtil.cloneFamily(cell)));</span><br><span class="line">        System.out.println(<span class="string">&quot; 列 :&quot;</span> + Bytes.toString(CellUtil.cloneQualifier(cell)));</span><br><span class="line">        System.out.println(<span class="string">&quot; 值 :&quot;</span> + Bytes.toString(CellUtil.cloneValue(cell)));</span><br><span class="line">        System.out.println(<span class="string">&quot;时间戳:&quot;</span> + cell.getTimestamp());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取某一行指定(列族:列)的数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getRowQualifier</span><span class="params">(</span></span><br><span class="line"><span class="params">    String tableName, String rowKey, String family, String qualifier)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="type">HTable</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HTable</span>(conf, tableName);</span><br><span class="line">    <span class="type">Get</span> <span class="variable">get</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Get</span>(Bytes.toBytes(rowKey));</span><br><span class="line">    get.addColumn(Bytes.toBytes(family),Bytes.toBytes(qualifier));</span><br><span class="line">    <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> table.get(get);</span><br><span class="line">    <span class="keyword">for</span>(Cell cell : result.rawCells())&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot; 行 键 :&quot;</span> + Bytes.toString(result.getRow()));</span><br><span class="line">        System.out.println(<span class="string">&quot; 列 族 &quot;</span> + Bytes.toString(CellUtil.cloneFamily(cell)));</span><br><span class="line">        System.out.println(<span class="string">&quot; 列 :&quot;</span> + Bytes.toString(CellUtil.cloneQualifier(cell)));</span><br><span class="line">        System.out.println(<span class="string">&quot; 值 :&quot;</span> + Bytes.toString(CellUtil.cloneValue(cell)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="mapreduce"><a class="markdownIt-Anchor" href="#mapreduce"></a> MapReduce</h4>
<p>通过 HBase 的相关 Java API，我们可以实现伴随 HBase 操作的 MapReduce 过程，比如使用 MapReduce 将数据从本地文件系统导入到 HBase 的表中，比如我们从 HBase 中读取一些原 始数据后使用 MapReduce 做数据分析。</p>
<h5 id="官方案例"><a class="markdownIt-Anchor" href="#官方案例"></a> 官方案例</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash"><span class="built_in">export</span> HBASE_HOME=/opt/module/hbase</span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash"><span class="built_in">export</span> HADOOP_HOME=/opt/module/hadoop-2.7.2</span></span><br><span class="line">vi hadoop-env.sh # 注意：在 for 循环之后配</span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash"><span class="built_in">export</span> HADOOP_CLASSPATH=<span class="variable">$HADOOP_CLASSPATH</span>:/opt/module/hbase/lib/*</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 MapReduce 将本地数据导入到 HBase</span></span><br><span class="line">vi fruit.tsv</span><br><span class="line">    # 1001 Apple Red</span><br><span class="line">    # 1002 Pear Yellow</span><br><span class="line">    # 1003 Pineapple Yellow</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建 Hbase 表</span></span><br><span class="line">Hbase(main):001:0&gt; create &#x27;fruit&#x27;,&#x27;info&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 HDFS 中创建 input_fruit 文件夹并上传 fruit.tsv 文件</span></span><br><span class="line">/opt/module/hadoop-2.7.2/bin/hdfs dfs -mkdir /input_fruit/</span><br><span class="line">/opt/module/hadoop-2.7.2/bin/hdfs dfs -put fruit.tsv /input_fruit/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行 MapReduce 到 HBase 的 fruit 表中</span></span><br><span class="line">/opt/module/hadoop-2.7.2/bin/yarn jar lib/hbase-server-1.3.1.jar</span><br><span class="line">importtsv \</span><br><span class="line">-Dimporttsv.columns=HBASE_ROW_KEY,info:name,info:color fruit \</span><br><span class="line">hdfs://hadoop102:9000/input_fruit</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 scan 命令查看导入后的结果</span></span><br><span class="line">Hbase(main):001:0&gt; scan ‘fruit’</span><br></pre></td></tr></table></figure>
<h5 id="自定义"><a class="markdownIt-Anchor" href="#自定义"></a> 自定义</h5>
<blockquote>
<p>将 fruit 表中的一部分数据，通过 MR 迁入到 fruit_mr 表中。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 继承的都是 HBase 提供的 Mapper 和 Reducer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadFruitMapper</span> <span class="keyword">extends</span> <span class="title class_">TableMapper</span>&lt;ImmutableBytesWritable, Put&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(ImmutableBytesWritable key, Result value, Context context)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 将 fruit 的 name 和 color 提取出来，相当于将每一行数据读取出来放入到 Put 对象中</span></span><br><span class="line">        <span class="type">Put</span> <span class="variable">put</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Put</span>(key.get());</span><br><span class="line">        <span class="comment">// 遍历添加 column 行</span></span><br><span class="line">        <span class="keyword">for</span>(Cell cell: value.rawCells())&#123;</span><br><span class="line">            <span class="comment">// 添加/克隆列族:info</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="string">&quot;info&quot;</span>.equals(Bytes.toString(CellUtil.cloneFamily(cell))))&#123;</span><br><span class="line">                <span class="comment">// 添加/克隆列：name</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="string">&quot;name&quot;</span>.equals(Bytes.toString(CellUtil.cloneQualifier(cell))))&#123;</span><br><span class="line">                    <span class="comment">// 将该列 cell 加入到 put 对象中</span></span><br><span class="line">                    put.add(cell);</span><br><span class="line">                    <span class="comment">// 添加/克隆列:color</span></span><br><span class="line">                &#125;<span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">if</span>(<span class="string">&quot;color&quot;</span>.equals(Bytes.toString(CellUtil.cloneQualifier(cell))))&#123;</span><br><span class="line">                        <span class="comment">// 向该列 cell 加入到 put 对象中</span></span><br><span class="line">                        put.add(cell);</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将从 fruit 读取到的每行数据写入到 context 中作为 map 的输出</span></span><br><span class="line">        context.write(key, put);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WriteFruitMRReducer</span> <span class="keyword">extends</span> <span class="title class_">TableReducer</span>&lt;ImmutableBytesWritable, Put, NullWritable&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">reduce</span><span class="params">(ImmutableBytesWritable key, Iterable&lt;Put&gt; values, Context context)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 读出来的每一行数据写入到 fruit_mr 表中</span></span><br><span class="line">        <span class="keyword">for</span>(Put put: values)&#123;</span><br><span class="line">            context.write(NullWritable.get(), put);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Fruit2FruitMRRunner</span> <span class="keyword">extends</span> <span class="title class_">Configured</span> <span class="keyword">implements</span> <span class="title class_">Tool</span>&#123;</span><br><span class="line">    <span class="comment">// 组装 Job</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 得到 Configuration</span></span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">conf</span> <span class="operator">=</span> <span class="built_in">this</span>.getConf();</span><br><span class="line">        <span class="comment">// 创建 Job 任务</span></span><br><span class="line">        <span class="type">Job</span> <span class="variable">job</span> <span class="operator">=</span> Job.getInstance(conf, <span class="built_in">this</span>.getClass().getSimpleName());</span><br><span class="line">        job.setJarByClass(Fruit2FruitMRRunner.class);</span><br><span class="line">        <span class="comment">// 配置 Job</span></span><br><span class="line">        <span class="type">Scan</span> <span class="variable">scan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scan</span>();</span><br><span class="line">        scan.setCacheBlocks(<span class="literal">false</span>);</span><br><span class="line">        scan.setCaching(<span class="number">500</span>);</span><br><span class="line">        <span class="comment">// 设置 Mapper，注意导入的是 mapreduce 包下的，不是 mapred 包下的，后者是老版本</span></span><br><span class="line">        TableMapReduceUtil.initTableMapperJob(</span><br><span class="line">            <span class="string">&quot;fruit&quot;</span>, <span class="comment">// 数据源的表名</span></span><br><span class="line">            scan, <span class="comment">// scan 扫描控制器</span></span><br><span class="line">            ReadFruitMapper.class, <span class="comment">// 设置 Mapper 类</span></span><br><span class="line">            ImmutableBytesWritable.class, <span class="comment">// 设置 Mapper 输出 key 类型</span></span><br><span class="line">            Put.class, <span class="comment">// 设置 Mapper 输出 value 值类型</span></span><br><span class="line">            job <span class="comment">// 设置给哪个 JOB</span></span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// 设置 Reducer</span></span><br><span class="line">        TableMapReduceUtil.initTableReducerJob(<span class="string">&quot;fruit_mr&quot;</span>, WriteFruitMRReducer.class, job);</span><br><span class="line">        <span class="comment">// 设置 Reduce 数量，最少 1 个</span></span><br><span class="line">        job.setNumReduceTasks(<span class="number">1</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> job.waitForCompletion(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span>(!isSuccess)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Job running with error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isSuccess ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">Configuration</span> <span class="variable">conf</span> <span class="operator">=</span> HbaseConfiguration.create();</span><br><span class="line">    <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> ToolRunner.run(conf, <span class="keyword">new</span> <span class="title class_">Fruit2FruitMRRunner</span>(), args);</span><br><span class="line">    System.exit(status);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>实现将 HDFS 中的数据写入到 Hbase 表中。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadFruitFromHDFSMapper</span> <span class="keyword">extends</span> <span class="title class_">Mapper</span>&lt;LongWritable, Text, ImmutableBytesWritable, Put&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(LongWritable key, Text value, Context context)</span> </span><br><span class="line">        <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">// 从 HDFS 中读取的数据</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lineValue</span> <span class="operator">=</span> value.toString();</span><br><span class="line">        <span class="comment">// 读取出来的每行数据使用 \t 进行分割，存于 String 数组</span></span><br><span class="line">        String[] values = lineValue.split(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">        <span class="comment">// 根据数据中值的含义取值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">rowKey</span> <span class="operator">=</span> values[<span class="number">0</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> values[<span class="number">1</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">color</span> <span class="operator">=</span> values[<span class="number">2</span>];</span><br><span class="line">        <span class="comment">// 初始化 rowKey</span></span><br><span class="line">        <span class="type">ImmutableBytesWritable</span> <span class="variable">rowKeyWritable</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">            <span class="title class_">ImmutableBytesWritable</span>(Bytes.toBytes(rowKey));</span><br><span class="line">        <span class="comment">// 初始化 put 对象</span></span><br><span class="line">        <span class="type">Put</span> <span class="variable">put</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Put</span>(Bytes.toBytes(rowKey));</span><br><span class="line">        <span class="comment">// 参数分别 列族、列、值</span></span><br><span class="line">        put.add(Bytes.toBytes(<span class="string">&quot;info&quot;</span>), Bytes.toBytes(<span class="string">&quot;name&quot;</span>), Bytes.toBytes(name));</span><br><span class="line">        put.add(Bytes.toBytes(<span class="string">&quot;info&quot;</span>), Bytes.toBytes(<span class="string">&quot;color&quot;</span>),Bytes.toBytes(color));</span><br><span class="line"></span><br><span class="line">        context.write(rowKeyWritable, put);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WriteFruitMRFromTxtReducer</span> <span class="keyword">extends</span> </span><br><span class="line">    <span class="title class_">TableReducer</span>&lt;ImmutableBytesWritable, Put, NullWritable&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">reduce</span><span class="params">(ImmutableBytesWritable key, Iterable&lt;Put&gt; values, Context context)</span> </span><br><span class="line">        <span class="keyword">throws</span> IOException, InterruptedException&#123;</span><br><span class="line">        <span class="comment">// 读出来的每一行数据写入到 fruit_hdfs 表中</span></span><br><span class="line">        <span class="keyword">for</span>(Put put: values)&#123;</span><br><span class="line">            context.write(NullWritable.get(), put);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Txt2FruitRunner</span> <span class="keyword">extends</span> <span class="title class_">Configured</span> <span class="keyword">implements</span> <span class="title class_">Tool</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 得到 Configuration</span></span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">conf</span> <span class="operator">=</span> <span class="built_in">this</span>.getConf();</span><br><span class="line">        <span class="comment">// 创建 Job 任务</span></span><br><span class="line">        <span class="type">Job</span> <span class="variable">job</span> <span class="operator">=</span> Job.getInstance(conf, <span class="built_in">this</span>.getClass().getSimpleName());</span><br><span class="line">        job.setJarByClass(Txt2FruitRunner.class);</span><br><span class="line">        <span class="type">Path</span> <span class="variable">inPath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;hdfs://hadoop102:9000/input_fruit/fruit.tsv&quot;</span>);</span><br><span class="line">        FileInputFormat.addInputPath(job, inPath);</span><br><span class="line">        <span class="comment">// 设置 Mapper</span></span><br><span class="line">        job.setMapperClass(ReadFruitFromHDFSMapper.class);</span><br><span class="line">        job.setMapOutputKeyClass(ImmutableBytesWritable.class);</span><br><span class="line">        job.setMapOutputValueClass(Put.class);</span><br><span class="line">        <span class="comment">// 设置 Reducer</span></span><br><span class="line">        TableMapReduceUtil.initTableReducerJob(<span class="string">&quot;fruit_mr&quot;</span>, WriteFruitMRFromTxtReducer.class, job);</span><br><span class="line">        <span class="comment">// 设置 Reduce 数量，最少 1 个</span></span><br><span class="line">        job.setNumReduceTasks(<span class="number">1</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> job.waitForCompletion(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span>(!isSuccess)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Job running with error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isSuccess ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="集成-hive"><a class="markdownIt-Anchor" href="#集成-hive"></a> 集成 Hive</h3>
<blockquote>
<p>操作 Hive 的同时对 HBase 也会产生影响，所以 Hive 需要持有操作 HBase 的 Jar。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里使用软链接的方式引包</span></span><br><span class="line">export HBASE_HOME=/opt/module/hbase</span><br><span class="line">export HIVE_HOME=/opt/module/hive</span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-common-1.3.1.jar $HIVE_HOME/lib/hbase-common-1.3.1.jar</span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-server-1.3.1.jar $HIVE_HOME/lib/hbaseserver-1.3.1.jar</span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-client-1.3.1.jar $HIVE_HOME/lib/hbase-client-1.3.1.jar</span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-protocol-1.3.1.jar $HIVE_HOME/lib/hbase-protocol-1.3.1.jar</span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-it-1.3.1.jar $HIVE_HOME/lib/hbase-it1.3.1.jar</span><br><span class="line">ln -s $HBASE_HOME/lib/htrace-core-3.1.0-incubating.jar $HIVE_HOME/lib/htrace-core-3.1.0-incubating.jar</span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-hadoop2-compat-1.3.1.jar $HIVE_HOME/lib/hbase-hadoop2-compat-1.3.1.jar</span><br><span class="line">ln -s $HBASE_HOME/lib/hbase-hadoop-compat-1.3.1.jar $HIVE_HOME/lib/hbase-hadoop-compat-1.3.1.jar</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 修改 hive-site.xml --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop102,hadoop103,hadoop104<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>The list of ZooKeeper servers to talk to. This is</span><br><span class="line">        only needed for read/write locks.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.zookeeper.client.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>The port of ZooKeeper servers to talk to. This is</span><br><span class="line">        only needed for read/write locks.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 Hive 中创建表同时关联 HBase</span></span><br><span class="line">CREATE TABLE hive_hbase_emp_table(</span><br><span class="line">    empno int,</span><br><span class="line">    ename string,</span><br><span class="line">    job string,</span><br><span class="line">    mgr int,</span><br><span class="line">    hiredate string,</span><br><span class="line">    sal double,</span><br><span class="line">    comm double,</span><br><span class="line">    deptno int</span><br><span class="line">)</span><br><span class="line">STORED BY &#x27;org.apache.hadoop.hive.hbase.HBaseStorageHandler&#x27;</span><br><span class="line">WITH SERDEPROPERTIES (&quot;hbase.columns.mapping&quot; = </span><br><span class="line">&quot;:key, info:ename, info:job, info:mgr,i nfo:hiredate,i nfo:sal, info:comm, info:deptno&quot;)</span><br><span class="line">TBLPROPERTIES (&quot;hbase.table.name&quot; = &quot;hbase_emp_table&quot;);</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">完成之后，可以分别进入 Hive 和 HBase 查看，都生成了对应的表</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">不能将数据直接 load 进 Hive 所关联 HBase 的那张表中</span></span><br><span class="line">CREATE TABLE emp(</span><br><span class="line">    empno int,</span><br><span class="line">    ename string,</span><br><span class="line">    job string,</span><br><span class="line">    mgr int,</span><br><span class="line">    hiredate string,</span><br><span class="line">    sal double,</span><br><span class="line">    comm double,</span><br><span class="line">    deptno int</span><br><span class="line">)</span><br><span class="line">row format delimited fields terminated by &#x27;\t&#x27;;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">向 Hive 中间表中 load 数据</span></span><br><span class="line">load data local inpath &#x27;/home/admin/softwares/data/emp.txt&#x27; into table emp;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过 insert 命令将中间表中的数据导入到 Hive 关联 Hbase 的那张表中</span></span><br><span class="line">insert into table hive_hbase_emp_table select * from emp;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看 Hive 以及关联的 HBase 表中是否已经成功的同步插入了数据</span></span><br><span class="line">select * from hive_hbase_emp_table;</span><br><span class="line">scan ‘hbase_emp_table’</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在 HBase 中已经存储了某一张表 hbase_emp_table，然后在 Hive 中创建一个外部表来关联 HBase 中的 hbase_emp_table 这张表，使之可以借助 Hive 来分析 HBase 这张表中的数据。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CREATE EXTERNAL TABLE relevance_hbase_emp(</span><br><span class="line">    empno int,</span><br><span class="line">    ename string,</span><br><span class="line">    job string,</span><br><span class="line">    mgr int,</span><br><span class="line">    hiredate string,</span><br><span class="line">    sal double,</span><br><span class="line">    comm double,</span><br><span class="line">    deptno int</span><br><span class="line">)</span><br><span class="line">STORED BY &#x27;org.apache.hadoop.hive.hbase.HBaseStorageHandler&#x27;</span><br><span class="line">WITH SERDEPROPERTIES (&quot;hbase.columns.mapping&quot; =</span><br><span class="line">&quot;:key, info:ename, info:job, info:mgr, info:hiredate, info:sal, info:comm, info:deptno&quot;)</span><br><span class="line">TBLPROPERTIES (&quot;hbase.table.name&quot; = &quot;hbase_emp_table&quot;);</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关联后就可以使用 Hive 函数进行一些分析操作了</span></span><br><span class="line"> select * from relevance_hbase_emp;</span><br></pre></td></tr></table></figure>
<h3 id="优化"><a class="markdownIt-Anchor" href="#优化"></a> 优化</h3>
<h4 id="高可用"><a class="markdownIt-Anchor" href="#高可用"></a> 高可用</h4>
<p>在 HBase 中 HMaster 负责监控 HRegionServer 的生命周期，均衡 RegionServer 的负载， 如果 HMaster 挂掉了，那么整个 HBase 集群将陷入不健康的状态，并且此时的工作状态并 不会维持太久。所以 HBase 支持对 HMaster 的高可用配置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭 HBase 集群</span></span><br><span class="line"> bin/stop-hbase.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 conf 目录下创建 backup-masters 文件</span></span><br><span class="line">touch conf/backup-masters</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 backup-masters 文件中配置高可用 HMaster 节点</span></span><br><span class="line">echo hadoop103 &gt; conf/backup-master</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将整个 conf 目录 scp 到其他节点</span></span><br><span class="line">scp -r conf/ hadoop103:/opt/module/hbase/</span><br><span class="line">scp -r conf/ hadoop104:/opt/module/hbase/</span><br></pre></td></tr></table></figure>
<h4 id="预分区"><a class="markdownIt-Anchor" href="#预分区"></a> 预分区</h4>
<p>每一个 region 维护着 StartRow 与 EndRow，如果加入的数据符合某个 Region 维护的 RowKey 范围，则该数据交给这个 Region 维护。那么依照这个原则，我们可以将数据所要投放的分区提前大致的规划好，以提高 HBase 性能。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">手动设定预分区</span></span><br><span class="line">create &#x27;staff1&#x27;,&#x27;info&#x27;,&#x27;partition1&#x27;,SPLITS =&gt; [&#x27;1000&#x27;,&#x27;2000&#x27;,&#x27;3000&#x27;,&#x27;4000&#x27;]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成 16 进制序列预分区</span></span><br><span class="line">create &#x27;staff2&#x27;,&#x27;info&#x27;,&#x27;partition2&#x27;,&#123;NUMREGIONS =&gt; 15, SPLITALGO =&gt; &#x27;HexStringSplit&#x27;&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">按照文件中设置的规则预分区</span></span><br><span class="line">create &#x27;staff3&#x27;,&#x27;partition3&#x27;,SPLITS_FILE =&gt; &#x27;splits.txt&#x27;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Java API</span></span><br><span class="line"><span class="comment">// 自定义算法，产生一系列 hash 散列值存储在二维数组中</span></span><br><span class="line"><span class="type">byte</span>[][] splitKeys = 某个散列值函数</span><br><span class="line"><span class="comment">// 创建 HbaseAdmin 实例</span></span><br><span class="line"><span class="type">HBaseAdmin</span> <span class="variable">hAdmin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HBaseAdmin</span>(HbaseConfiguration.create());</span><br><span class="line"><span class="comment">// 创建 HTableDescriptor 实例</span></span><br><span class="line"><span class="type">HTableDescriptor</span> <span class="variable">tableDesc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HTableDescriptor</span>(tableName);</span><br><span class="line"><span class="comment">// 通过 HTableDescriptor 实例和散列值二维数组创建带有预分区的 Hbase 表</span></span><br><span class="line">hAdmin.createTable(tableDesc, splitKeys);</span><br></pre></td></tr></table></figure>
<h4 id="rowkey"><a class="markdownIt-Anchor" href="#rowkey"></a> RowKey</h4>
<p>一条数据的唯一标识就是 RowKey，那么这条数据存储于哪个分区，取决于 RowKey 处于哪个一个预分区的区间内，设计 RowKey 的主要目的 ，就是让数据均匀的分布于所有的 region 中，在一定程度上防止数据倾斜。</p>
<p>HASH，在做此操作之前，一般我们会选择从数据集中抽取样本，来决定什么样的 rowKey 来 Hash 后作为每个分区的临界值。</p>
<h4 id="内存优化"><a class="markdownIt-Anchor" href="#内存优化"></a> 内存优化</h4>
<p>HBase 操作过程中需要大量的内存开销，毕竟 Table 是可以缓存在内存中的，一般会分配整个可用内存的 70%给 HBase 的 Java 堆。但是不建议分配非常大的堆内存，因为 GC  程持续太久会导致 RegionServer 处于长期不可用状态，一般 16~48G 内存就可以了，如果因为框架占用内存过高导致系统内存不足，框架一样会被系统服务拖死。</p>
<ul>
<li>
<p>属性：dfs.support.append<br />
解释：开启 HDFS 追加同步，可以优秀的配合 HBase 的数据同步和持久化。<br />
默认值为 true。</p>
</li>
<li>
<p>属性：dfs.datanode.max.transfer.threads 	<br />
解释：HBase 一般都会同一时间操作大量的文件，根据集群的数量和规模以及数据动作， 设置为 4096 或者更高。<br />
默认值：4096</p>
</li>
<li>
<p>属性：dfs.image.transfer.timeout<br />
解释：如果对于某一次数据操作来讲，延迟非常高，socket 需要等待更长的时间，建议把该值设置为更大的值（默认 60000 毫秒），以确保 socket 不会被 timeout 掉。</p>
</li>
<li>
<p>属性：mapreduce.map.output.compress mapreduce.map.output.compress.codec<br />
解释：开启这两个数据可以大大提高文件的写入效率，减少写入时间。第一个属性值修改为 true，第二个属性值修改为：org.apache.hadoop.io.compress.GzipCodec 或者其他压缩方式。</p>
</li>
<li>
<p>属性：Hbase.regionserver.handler.count<br />
解释：默认值为 30，用于指定 RPC 监听的数量，可以根据客户端的请求数进行调整，读写请求较多时，增加此值。</p>
</li>
<li>
<p>属性：hbase.hregion.max.filesize<br />
解释：默认值 10737418240（10GB），如果需要运行 HBase 的 MR 任务，可以减小此值， 因为一个 region 对应一个 map 任务，如果单个 region 过大，会导致 map 任务执行时间过长。该值的意思就是，如果 HFile 的大小达到这个数值，则这个 region 会被切分为两个 Hfile。</p>
</li>
<li>
<p>属性：hbase.client.write.buffer<br />
解释：用于指定 Hbase 客户端缓存，增大该值可以减少 RPC 调用次数，但是会消耗更多内存，反之则反之。一般我们需要设定一定的缓存大小，以达到减少 RPC 次数的目的。</p>
</li>
<li>
<p>属性：hbase.client.scanner.caching<br />
解释：用于指定 scan.next 方法获取的默认行数，值越大，消耗内存越大。</p>
</li>
</ul>
<p>flush、compact、split 机制</p>
<p>当 MemStore 达到阈值，将 Memstore 中的数据 Flush 进 Storefile；compact 机制则是把 flush 出来的小文件合并成大的 Storefile 文件。split 则是当 Region 达到阈值，会把过大的 Region 一分为二。</p>
<ul>
<li>
<p>hbase.hregion.memstore.flush.size：134217728</p>
<p>这个参数的作用是当单个 HRegion 内所有的 Memstore 大小总和超过指定值时，flush 该 HRegion 的所有 memstore。RegionServer 的 flush 是通过将请求添加一个队列，模拟生 产消费模型来异步处理的。那这里就有一个问题，当队列来不及消费，产生大量积压请求 时，可能会导致内存陡增，最坏的情况是触发 OOM</p>
</li>
<li>
<p>hbase.regionserver.global.memstore.upperLimit：0.4<br />
hbase.regionserver.global.memstore.lowerLimit：0.38<br />
当 MemStore 使用内存总量达到hbase.regionserver.global.memstore.upperLimit 指定值时，将会有多个 MemStores flush 到文件中，MemStore flush 顺序是按照大小降序执行的，直到刷新到 MemStore 使用内存略小于 lowerLimit</p>
</li>
</ul>
<h3 id="项目实战"><a class="markdownIt-Anchor" href="#项目实战"></a> 项目实战</h3>
<blockquote>
<p>微博内容的浏览，数据库表设计；<br />
用户社交体现：关注用户，取关用户；<br />
拉取关注的人的微博内容。</p>
</blockquote>
<h4 id="表的创建"><a class="markdownIt-Anchor" href="#表的创建"></a> 表的创建</h4>
<p><img src="/img//2020/05/HBase/HBase09.jpg" alt="" /></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建命名空间以及表名的定义</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取配置 conf</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Configuration</span> <span class="variable">conf</span> <span class="operator">=</span> HbaseConfiguration.create();</span><br><span class="line"><span class="comment">// 微博内容表的表名</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] TABLE_CONTENT = Bytes.toBytes(<span class="string">&quot;weibo:content&quot;</span>);</span><br><span class="line"><span class="comment">// 用户关系表的表名</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] TABLE_RELATIONS = Bytes.toBytes(<span class="string">&quot;weibo:relations&quot;</span>);</span><br><span class="line"><span class="comment">// 微博收件箱表的表名</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] TABLE_RECEIVE_CONTENT_EMAIL = </span><br><span class="line">    Bytes.toBytes(<span class="string">&quot;weibo:receive_content_email&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initNamespace</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">HbaseAdmin</span> <span class="variable">admin</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        admin = <span class="keyword">new</span> <span class="title class_">HbaseAdmin</span>(conf);</span><br><span class="line">        <span class="comment">// 命名空间类似于关系型数据库中的 schema，可以想象成文件夹</span></span><br><span class="line">        <span class="type">NamespaceDescriptor</span> <span class="variable">weibo</span> <span class="operator">=</span> NamespaceDescriptor</span><br><span class="line">            .create(<span class="string">&quot;weibo&quot;</span>)</span><br><span class="line">            .addConfiguration(<span class="string">&quot;creator&quot;</span>, <span class="string">&quot;wingo&quot;</span>)</span><br><span class="line">            .addConfiguration(<span class="string">&quot;create_time&quot;</span>, System.currentTimeMillis() + <span class="string">&quot;&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">        admin.createNamespace(weibo);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MasterNotRunningException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ZooKeeperConnectionException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != admin)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                admin.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建微博内容表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 表结构</span></span><br><span class="line"><span class="comment">Table Name 		weibo:content</span></span><br><span class="line"><span class="comment">RowKey			用户 ID_时间戳</span></span><br><span class="line"><span class="comment">ColumnFamily 	info</span></span><br><span class="line"><span class="comment">ColumnLabel 	内容</span></span><br><span class="line"><span class="comment">Version 		1 个版本</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTableContent</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">HbaseAdmin</span> <span class="variable">admin</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        admin = <span class="keyword">new</span> <span class="title class_">HbaseAdmin</span>(conf);</span><br><span class="line">        <span class="comment">// 创建表表述</span></span><br><span class="line">        <span class="type">HTableDescriptor</span> <span class="variable">content</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HTableDescriptor</span>(TableName.valueOf(TABLE_CONTENT));</span><br><span class="line">        <span class="comment">// 创建列族描述</span></span><br><span class="line">        <span class="type">HColumnDescriptor</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HColumnDescriptor</span>(Bytes.toBytes(<span class="string">&quot;info&quot;</span>));</span><br><span class="line">        <span class="comment">// 设置块缓存</span></span><br><span class="line">        info.setBlockCacheEnabled(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 设置块缓存大小</span></span><br><span class="line">        info.setBlocksize(<span class="number">2097152</span>);</span><br><span class="line">        <span class="comment">// 设置压缩方式</span></span><br><span class="line">        <span class="comment">// info.setCompressionType(Algorithm.SNAPPY);</span></span><br><span class="line">        <span class="comment">// 设置版本数量</span></span><br><span class="line">        info.setMaxVersions(<span class="number">1</span>);</span><br><span class="line">        info.setMinVersions(<span class="number">1</span>);</span><br><span class="line">        content.addFamily(info);</span><br><span class="line">        admin.createTable(content);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MasterNotRunningException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ZooKeeperConnectionException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != admin)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                admin.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建用户关系表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 表结构</span></span><br><span class="line"><span class="comment">Table Name 		weibo:relations</span></span><br><span class="line"><span class="comment">RowKey 			用户 ID</span></span><br><span class="line"><span class="comment">ColumnFamily 	attends、fans</span></span><br><span class="line"><span class="comment">ColumnLabel 	关注用户 ID，粉丝用户 ID</span></span><br><span class="line"><span class="comment">ColumnValue 	用户 ID</span></span><br><span class="line"><span class="comment">Version 		1 个版本</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTableRelations</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">HbaseAdmin</span> <span class="variable">admin</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        admin = <span class="keyword">new</span> <span class="title class_">HbaseAdmin</span>(conf);</span><br><span class="line">        <span class="type">HTableDescriptor</span> <span class="variable">relations</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HTableDescriptor</span>(TableName.valueOf(TABLE_RELATIONS));</span><br><span class="line">        <span class="type">HColumnDescriptor</span> <span class="variable">attends</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HColumnDescriptor</span>(Bytes.toBytes(<span class="string">&quot;attends&quot;</span>));</span><br><span class="line">        attends.setBlockCacheEnabled(<span class="literal">true</span>);</span><br><span class="line">        attends.setBlocksize(<span class="number">2097152</span>);</span><br><span class="line">        attends.setMaxVersions(<span class="number">1</span>);</span><br><span class="line">        attends.setMinVersions(<span class="number">1</span>);</span><br><span class="line">        <span class="type">HColumnDescriptor</span> <span class="variable">fans</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HColumnDescriptor</span>(Bytes.toBytes(<span class="string">&quot;fans&quot;</span>));</span><br><span class="line">        fans.setBlockCacheEnabled(<span class="literal">true</span>);</span><br><span class="line">        fans.setBlocksize(<span class="number">2097152</span>);</span><br><span class="line">        fans.setMaxVersions(<span class="number">1</span>);</span><br><span class="line">        fans.setMinVersions(<span class="number">1</span>);</span><br><span class="line">        relations.addFamily(attends);</span><br><span class="line">        relations.addFamily(fans);</span><br><span class="line">        admin.createTable(relations);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MasterNotRunningException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ZooKeeperConnectionException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != admin)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                admin.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建微博收件箱表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 表结构</span></span><br><span class="line"><span class="comment">Table Name 		weibo:receive_content_email</span></span><br><span class="line"><span class="comment">RowKey 			用户 ID</span></span><br><span class="line"><span class="comment">ColumnFamily 	info</span></span><br><span class="line"><span class="comment">ColumnLabel 	用户 ID</span></span><br><span class="line"><span class="comment">ColumnValue 	取微博内容的 RowKey</span></span><br><span class="line"><span class="comment">Version 		1000</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createTableReceiveContentEmail</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">HbaseAdmin</span> <span class="variable">admin</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        admin = <span class="keyword">new</span> <span class="title class_">HbaseAdmin</span>(conf);</span><br><span class="line">        <span class="type">HTableDescriptor</span> <span class="variable">receive_content_email</span> <span class="operator">=</span> <span class="keyword">new</span> </span><br><span class="line">            <span class="title class_">HTableDescriptor</span>(TableName.valueOf(TABLE_RECEIVE_CONTENT_EMAIL));</span><br><span class="line">        <span class="type">HColumnDescriptor</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HColumnDescriptor</span>(Bytes.toBytes(<span class="string">&quot;info&quot;</span>));</span><br><span class="line">        info.setBlockCacheEnabled(<span class="literal">true</span>);</span><br><span class="line">        info.setBlocksize(<span class="number">2097152</span>);</span><br><span class="line">        info.setMaxVersions(<span class="number">1000</span>);</span><br><span class="line">        info.setMinVersions(<span class="number">1000</span>);</span><br><span class="line">        receive_content_email.addFamily(info);;</span><br><span class="line">        admin.createTable(receive_content_email);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MasterNotRunningException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ZooKeeperConnectionException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != admin)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                admin.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="功能实现"><a class="markdownIt-Anchor" href="#功能实现"></a> 功能实现</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">微博内容表中添加 1 条数据</span></span><br><span class="line"><span class="comment">微博收件箱表对所有粉丝用户添加数据：微博内容的 RowKey</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String uid;</span><br><span class="line">    <span class="keyword">private</span> String timestamp;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUid</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> uid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUid</span><span class="params">(String uid)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.uid = uid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTimestamp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> timestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTimestamp</span><span class="params">(String timestamp)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.timestamp = timestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getContent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContent</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Message [uid=&quot;</span> + uid + <span class="string">&quot;, timestamp=&quot;</span> + timestamp +</span><br><span class="line">            <span class="string">&quot;, content=&quot;</span> + content + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publishContent</span><span class="params">(String uid, String content)</span>&#123;</span><br><span class="line">    <span class="type">HConnection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        connection = HConnectionManager.createConnection(conf);</span><br><span class="line">        <span class="comment">// 微博内容表中添加 1 条数据，首先获取微博内容表描述</span></span><br><span class="line">        <span class="type">HTableInterface</span> <span class="variable">contentTBL</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(TABLE_CONTENT));</span><br><span class="line">        <span class="comment">// 组装 Rowkey</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">String</span> <span class="variable">rowKey</span> <span class="operator">=</span> uid + <span class="string">&quot;_&quot;</span> + timestamp;</span><br><span class="line">        <span class="type">Put</span> <span class="variable">put</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Put</span>(Bytes.toBytes(rowKey));</span><br><span class="line">        put.add(Bytes.toBytes(<span class="string">&quot;info&quot;</span>), Bytes.toBytes(<span class="string">&quot;content&quot;</span>), timestamp, Bytes.toBytes(content));</span><br><span class="line">        contentTBL.put(put);</span><br><span class="line">        <span class="comment">// 向微博收件箱表中加入发布的 Rowkey</span></span><br><span class="line">        <span class="comment">// 查询用户关系表，得到当前用户有哪些粉丝</span></span><br><span class="line">        <span class="type">HTableInterface</span> <span class="variable">relationsTBL</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(TABLE_RELATIONS));</span><br><span class="line">        <span class="comment">// 取出目标数据</span></span><br><span class="line">        <span class="type">Get</span> <span class="variable">get</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Get</span>(Bytes.toBytes(uid));</span><br><span class="line">        <span class="comment">// 指定取出的目标数据的值</span></span><br><span class="line">        get.addFamily(Bytes.toBytes(<span class="string">&quot;fans&quot;</span>));</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> relationsTBL.get(get);</span><br><span class="line">        <span class="comment">// 初始化一个二进制数组用于存放数据</span></span><br><span class="line">        List&lt;<span class="type">byte</span>[]&gt; fans = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;<span class="type">byte</span>[]&gt;();</span><br><span class="line">        <span class="comment">// 遍历取出当前发布微博的用户的所有粉丝数据</span></span><br><span class="line">        <span class="keyword">for</span>(Cell cell : result.rawCells())&#123;</span><br><span class="line">            fans.add(CellUtil.cloneQualifier(cell));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果该用户没有粉丝，则直接 return</span></span><br><span class="line">        <span class="keyword">if</span>(fans.size() &lt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// 开始操作收件箱表</span></span><br><span class="line">        <span class="type">HTableInterface</span> <span class="variable">recTBL</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(TABLE_RECEIVE_CONTENT_EMAIL));</span><br><span class="line">        List&lt;Put&gt; puts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Put&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">byte</span>[] fan : fans)&#123;</span><br><span class="line">            <span class="type">Put</span> <span class="variable">fanPut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Put</span>(fan);</span><br><span class="line">            fanPut.add(Bytes.toBytes(<span class="string">&quot;info&quot;</span>), Bytes.toBytes(uid), timestamp, Bytes.toBytes(rowKey));</span><br><span class="line">            puts.add(fanPut);</span><br><span class="line">        &#125;</span><br><span class="line">        recTBL.put(puts);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != connection)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加关注用户</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">在微博用户关系表中，对当前主动操作的用户添加新关注的好友</span></span><br><span class="line"><span class="comment">在微博用户关系表中，对被关注的用户添加新的粉丝</span></span><br><span class="line"><span class="comment">微博收件箱表中添加所关注的用户发布的微博</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addAttends</span><span class="params">(String uid, String... attends)</span>&#123;</span><br><span class="line">    <span class="comment">// 参数过滤</span></span><br><span class="line">    <span class="keyword">if</span>(attends == <span class="literal">null</span> || attends.length &lt;= <span class="number">0</span> || uid == <span class="literal">null</span> || uid.length() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">HConnection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        connection = HConnectionManager.createConnection(conf);</span><br><span class="line">        <span class="comment">// 用户关系表操作对象（连接到用户关系表）</span></span><br><span class="line">        <span class="type">HTableInterface</span> <span class="variable">relationsTBL</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(TABLE_RELATIONS));</span><br><span class="line">        List&lt;Put&gt; puts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Put&gt;();</span><br><span class="line">        <span class="comment">// 在微博用户关系表中，添加新关注的好友</span></span><br><span class="line">        <span class="type">Put</span> <span class="variable">attendPut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Put</span>(Bytes.toBytes(uid));</span><br><span class="line">        <span class="keyword">for</span>(String attend : attends)&#123;</span><br><span class="line">            <span class="comment">// 为当前用户添加关注的人</span></span><br><span class="line">            attendPut.add(Bytes.toBytes(<span class="string">&quot;attends&quot;</span>), Bytes.toBytes(attend), Bytes.toBytes(attend));</span><br><span class="line">            <span class="comment">// 为被关注的人，添加粉丝</span></span><br><span class="line">            <span class="type">Put</span> <span class="variable">fansPut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Put</span>(Bytes.toBytes(attend));</span><br><span class="line">            fansPut.add(Bytes.toBytes(<span class="string">&quot;fans&quot;</span>), Bytes.toBytes(uid), Bytes.toBytes(uid));</span><br><span class="line">            <span class="comment">// 将所有关注的人一个一个的添加到 puts（List）集合中</span></span><br><span class="line">            puts.add(fansPut);</span><br><span class="line">        &#125;</span><br><span class="line">        puts.add(attendPut);</span><br><span class="line">        relationsTBL.put(puts);</span><br><span class="line">        <span class="comment">// 微博收件箱添加关注的用户发布的微博内容（content）的 rowkey</span></span><br><span class="line">        <span class="type">HTableInterface</span> <span class="variable">contentTBL</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(TABLE_CONTENT));</span><br><span class="line">        <span class="type">Scan</span> <span class="variable">scan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scan</span>();</span><br><span class="line">        <span class="comment">// 用于存放取出来的关注的人所发布的微博的 rowkey</span></span><br><span class="line">        List&lt;<span class="type">byte</span>[]&gt; rowkeys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;<span class="type">byte</span>[]&gt;();</span><br><span class="line">        <span class="keyword">for</span>(String attend : attends)&#123;</span><br><span class="line">            <span class="comment">// 过滤扫描 rowkey，即：前置位匹配被关注的人的 uid_</span></span><br><span class="line">            <span class="type">RowFilter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RowFilter</span></span><br><span class="line">                (CompareFilter.CompareOp.EQUAL, <span class="keyword">new</span> <span class="title class_">SubstringComparator</span>(attend + <span class="string">&quot;_&quot;</span>));</span><br><span class="line">            <span class="comment">// 为扫描对象指定过滤规则</span></span><br><span class="line">            scan.setFilter(filter);</span><br><span class="line">            <span class="comment">// 通过扫描对象得到 scanner</span></span><br><span class="line">            <span class="type">ResultScanner</span> <span class="variable">result</span> <span class="operator">=</span> contentTBL.getScanner(scan);</span><br><span class="line">            <span class="comment">// 迭代器遍历扫描出来的结果集</span></span><br><span class="line">            Iterator&lt;Result&gt; iterator = result.iterator();</span><br><span class="line">            <span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">                <span class="comment">// 取出每一个符合扫描结果的那一行数据</span></span><br><span class="line">                <span class="type">Result</span> <span class="variable">r</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                <span class="keyword">for</span>(Cell cell : r.rawCells())&#123;</span><br><span class="line">                    <span class="comment">// 将得到的 rowkey 放置于集合容器中</span></span><br><span class="line">                    rowkeys.add(CellUtil.cloneRow(cell));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将取出的微博 rowkey 放置于当前操作用户的收件箱中</span></span><br><span class="line">        <span class="keyword">if</span>(rowkeys.size() &lt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// 得到微博收件箱表的操作对象</span></span><br><span class="line">        <span class="type">HTableInterface</span> <span class="variable">recTBL</span> <span class="operator">=</span>connection.getTable(TableName.valueOf(TABLE_RECEIVE_CONTENT_EMAIL));</span><br><span class="line">        <span class="comment">// 用于存放多个关注的用户的发布的多条微博 rowkey 信息</span></span><br><span class="line">        List&lt;Put&gt; recPuts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Put&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">byte</span>[] rk : rowkeys)&#123;</span><br><span class="line">            <span class="type">Put</span> <span class="variable">put</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Put</span>(Bytes.toBytes(uid));</span><br><span class="line">            <span class="comment">// uid_timestamp</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">rowKey</span> <span class="operator">=</span> Bytes.toString(rk);</span><br><span class="line">            <span class="comment">// 截取 uid</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">attendUID</span> <span class="operator">=</span> rowKey.substring(<span class="number">0</span>, rowKey.indexOf(<span class="string">&quot;_&quot;</span>));</span><br><span class="line">            <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> Long.parseLong(rowKey.substring(rowKey.indexOf(<span class="string">&quot;_&quot;</span>) + <span class="number">1</span>));</span><br><span class="line">            <span class="comment">// 将微博 rowkey 添加到指定单元格中</span></span><br><span class="line">            put.add(Bytes.toBytes(<span class="string">&quot;info&quot;</span>), Bytes.toBytes(attendUID), timestamp, rk);</span><br><span class="line">            recPuts.add(put);</span><br><span class="line">        &#125;</span><br><span class="line">        recTBL.put(recPuts);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != connection)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>取关用户</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 即关注用户的反向操作</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeAttends</span><span class="params">(String uid, String... attends)</span>&#123;</span><br><span class="line">    <span class="comment">// 过滤数据</span></span><br><span class="line">    <span class="keyword">if</span>(uid == <span class="literal">null</span> || uid.length() &lt;= <span class="number">0</span> || attends == <span class="literal">null</span> || attends.length &lt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="type">HConnection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        connection = HConnectionManager.createConnection(conf);</span><br><span class="line">        <span class="comment">// 在微博用户关系表中，删除已关注的好友</span></span><br><span class="line">        <span class="type">HTableInterface</span> <span class="variable">relationsTBL</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(TABLE_RELATIONS));</span><br><span class="line">        <span class="comment">// 待删除的用户关系表中的所有数据</span></span><br><span class="line">        List&lt;Delete&gt; deletes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Delete&gt;();</span><br><span class="line">        <span class="comment">// 当前取关操作者的 uid 对应的 Delete 对象</span></span><br><span class="line">        <span class="type">Delete</span> <span class="variable">attendDelete</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Delete</span>(Bytes.toBytes(uid));</span><br><span class="line">        <span class="comment">// 遍历取关，同时每次取关都要将被取关的人的粉丝 -1</span></span><br><span class="line">        <span class="keyword">for</span>(String attend : attends)&#123;</span><br><span class="line">            attendDelete.deleteColumn(Bytes.toBytes(<span class="string">&quot;attends&quot;</span>), Bytes.toBytes(attend));</span><br><span class="line">            <span class="type">Delete</span> <span class="variable">fansDelete</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Delete</span>(Bytes.toBytes(attend));</span><br><span class="line">            fansDelete.deleteColumn(Bytes.toBytes(<span class="string">&quot;fans&quot;</span>), Bytes.toBytes(uid));</span><br><span class="line">            deletes.add(fansDelete);</span><br><span class="line">        &#125;</span><br><span class="line">        deletes.add(attendDelete);</span><br><span class="line">        relationsTBL.delete(deletes);</span><br><span class="line">        <span class="comment">//  收件箱表中删除取关的人的微博 rowkey</span></span><br><span class="line">        <span class="type">HTableInterface</span> <span class="variable">recTBL</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(TABLE_RECEIVE_CONTENT_EMAIL));</span><br><span class="line">        <span class="type">Delete</span> <span class="variable">recDelete</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Delete</span>(Bytes.toBytes(uid));</span><br><span class="line">        <span class="keyword">for</span>(String attend : attends)&#123;</span><br><span class="line">            recDelete.deleteColumn(Bytes.toBytes(<span class="string">&quot;info&quot;</span>), Bytes.toBytes(attend));</span><br><span class="line">        &#125;</span><br><span class="line">        recTBL.delete(recDelete);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取关注的人的微博内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 即通过微博收件箱中的 RowKey 获取对应的微博内容</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> List&lt;Message&gt; <span class="title function_">getAttendsContent</span><span class="params">(String uid)</span>&#123;</span><br><span class="line">    <span class="type">HConnection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        connection = HConnectionManager.createConnection(conf);</span><br><span class="line">        <span class="type">HTableInterface</span> <span class="variable">recTBL</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(TABLE_RECEIVE_CONTENT_EMAIL));</span><br><span class="line">        <span class="comment">// 从收件箱中取得微博 rowKey</span></span><br><span class="line">        <span class="type">Get</span> <span class="variable">get</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Get</span>(Bytes.toBytes(uid));</span><br><span class="line">        <span class="comment">// 设置最大版本号</span></span><br><span class="line">        get.setMaxVersions(<span class="number">5</span>);</span><br><span class="line">        List&lt;<span class="type">byte</span>[]&gt; rowkeys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;<span class="type">byte</span>[]&gt;();</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> recTBL.get(get);</span><br><span class="line">        <span class="keyword">for</span>(Cell cell : result.rawCells())&#123;</span><br><span class="line">            rowkeys.add(CellUtil.cloneValue(cell));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据取出的所有 rowkey 去微博内容表中检索数据</span></span><br><span class="line">        <span class="type">HTableInterface</span> <span class="variable">contentTBL</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(TABLE_CONTENT));</span><br><span class="line">        List&lt;Get&gt; gets = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Get&gt;();</span><br><span class="line">        <span class="comment">// 根据 rowkey 取出对应微博的具体内容</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">byte</span>[] rk : rowkeys)&#123;</span><br><span class="line">            <span class="type">Get</span> <span class="variable">g</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Get</span>(rk);</span><br><span class="line">            gets.add(g);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 得到所有的微博内容的 result 对象</span></span><br><span class="line">        Result[] results = contentTBL.get(gets);</span><br><span class="line">        List&lt;Message&gt; messages = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Message&gt;();</span><br><span class="line">        <span class="keyword">for</span>(Result res : results)&#123;</span><br><span class="line">            <span class="keyword">for</span>(Cell cell : res.rawCells())&#123;</span><br><span class="line">                <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">                <span class="type">String</span> <span class="variable">rowKey</span> <span class="operator">=</span> Bytes.toString(CellUtil.cloneRow(cell));</span><br><span class="line">                <span class="type">String</span> <span class="variable">userid</span> <span class="operator">=</span> rowKey.substring(<span class="number">0</span>, rowKey.indexOf(<span class="string">&quot;_&quot;</span>));</span><br><span class="line">                <span class="type">String</span> <span class="variable">timestamp</span> <span class="operator">=</span> rowKey.substring(rowKey.indexOf(<span class="string">&quot;_&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> Bytes.toString(CellUtil.cloneValue(cell));</span><br><span class="line">                message.setContent(content);</span><br><span class="line">                message.setTimestamp(timestamp);</span><br><span class="line">                message.setUid(userid);</span><br><span class="line">                messages.add(message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> messages;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <!-- <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://wingowen.github.io/2020/05/03/%E5%A4%A7%E6%95%B0%E6%8D%AE/HBase/" title="Hbase" target="_blank" rel="external">https://wingowen.github.io/2020/05/03/大数据/HBase/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">WINGO.WEN</span><small class="ml-1x"></small></a></h3>
        <div>一个疯子。</div>
      </div>
    </figure>
  </div>
</div>


    </div> -->
  </article>
  
    
  <section id="comments">
  	
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2020/05/06/%E5%A4%A7%E6%95%B0%E6%8D%AE/Kafka/" title="Kafka"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2020/04/30/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%8D%81%E5%A4%A7%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%86%85%E9%83%A8%E6%8E%92%E5%BA%8F%EF%BC%89/" title="算法整理"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">    <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
    <div class="copyright">
    	
        <div class="publishby">
        	<!-- Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>. -->
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   






</body>
</html>