<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Chatroom 简介 | WINGO BLOG</title>
  <meta name="description" content="一个网页版的线上聊天室">
<meta property="og:type" content="article">
<meta property="og:title" content="Chatroom 简介">
<meta property="og:url" content="https://wingowen.github.io/2020/01/31/%E5%90%8E%E5%8F%B0%E6%8A%80%E6%9C%AF/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/%E8%81%8A%E5%A4%A9%E5%AE%A4%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="WINGO&#39;S BLOG">
<meta property="og:description" content="一个网页版的线上聊天室">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wingowen.github.io/img/2020/01/Chatroom/ServerModel.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/01/Chatroom/ServerModel.PNG">
<meta property="og:image" content="http://gudtwingo.gitee.io/Image/2020/02/ChatRoom/ServletLife.PNG">
<meta property="og:image" content="http://gudtwingo.gitee.io/Image/2020/02/ChatRoom/SpringMybatiscatalog.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/SpringMybatisTest01.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/SpringMVCFlow.jpg">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/SpringMVCatalog.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/SpringMVCInit.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/SpringMVCLogin.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/SwaggerTest01.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/SwaggerTest02.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/Database.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/LoginFlow.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/ChatroomFlow.PNG">
<meta property="og:image" content="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/POVO.PNG">
<meta property="og:image" content="https://wingowen.github.io/img/2020/03/Chatroom/Layout01.png">
<meta property="og:image" content="https://wingowen.github.io/img/2020/03/Chatroom/UserInfoInit.PNG">
<meta property="og:image" content="https://wingowen.github.io/img/2020/03/Chatroom/SingleSend.PNG">
<meta property="og:image" content="https://wingowen.github.io/img/2020/03/Chatroom/Test02.PNG">
<meta property="og:image" content="https://wingowen.github.io/img/2020/03/Chatroom/Test03.PNG">
<meta property="og:image" content="https://wingowen.github.io/img/2020/03/Chatroom/Test01.PNG">
<meta property="og:image" content="https://wingowen.github.io/img/2020/03/Chatroom/Test04.PNG">
<meta property="article:published_time" content="2020-01-31T04:16:27.000Z">
<meta property="article:modified_time" content="2023-09-20T08:20:35.793Z">
<meta property="article:author" content="Wingo Wen">
<meta property="article:tag" content="demo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wingowen.github.io/img/2020/01/Chatroom/ServerModel.PNG">
  <!-- Canonical links -->
  <link rel="canonical" href="https://wingowen.github.io/2020/01/31/%E5%90%8E%E5%8F%B0%E6%8A%80%E6%9C%AF/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/%E8%81%8A%E5%A4%A9%E5%AE%A4%E9%A1%B9%E7%9B%AE/index.html">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="WINGO'S BLOG" type="application/atom+xml">
</head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">WINGO.WEN</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
      </ul>
      
    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>得失从缘 心无增减</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9F%BA%E7%A1%80%E7%A7%91%E5%AD%A6/">基础科学</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E9%A1%B9/">杂项</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/">计算机科学</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a><span class="category-list-count">5</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Aysnc/" style="font-size: 13px;">Aysnc</a> <a href="/tags/Cache/" style="font-size: 13px;">Cache</a> <a href="/tags/Druid/" style="font-size: 13px;">Druid</a> <a href="/tags/Dubbo/" style="font-size: 13px;">Dubbo</a> <a href="/tags/ElasticSearch/" style="font-size: 13px;">ElasticSearch</a> <a href="/tags/Email/" style="font-size: 13px;">Email</a> <a href="/tags/Flume/" style="font-size: 13px;">Flume</a> <a href="/tags/Git/" style="font-size: 13px;">Git</a> <a href="/tags/HBase/" style="font-size: 13px;">HBase</a> <a href="/tags/Hadoop/" style="font-size: 13px;">Hadoop</a> <a href="/tags/Hive/" style="font-size: 13.2px;">Hive</a> <a href="/tags/Impala/" style="font-size: 13px;">Impala</a> <a href="/tags/InooDB/" style="font-size: 13px;">InooDB</a> <a href="/tags/JDBC/" style="font-size: 13px;">JDBC</a> <a href="/tags/JPA/" style="font-size: 13px;">JPA</a> <a href="/tags/Kafka/" style="font-size: 13px;">Kafka</a> <a href="/tags/Kudu/" style="font-size: 13.2px;">Kudu</a> <a href="/tags/Linux/" style="font-size: 13px;">Linux</a> <a href="/tags/Log/" style="font-size: 13px;">Log</a> <a href="/tags/MQ/" style="font-size: 13.2px;">MQ</a> <a href="/tags/MyBatis/" style="font-size: 13px;">MyBatis</a> <a href="/tags/MySQL/" style="font-size: 13px;">MySQL</a> <a href="/tags/Netty/" style="font-size: 14px;">Netty</a> <a href="/tags/Pandas/" style="font-size: 13px;">Pandas</a> <a href="/tags/SQL/" style="font-size: 13px;">SQL</a> <a href="/tags/Scheduled/" style="font-size: 13px;">Scheduled</a> <a href="/tags/Security/" style="font-size: 13px;">Security</a> <a href="/tags/Shiro/" style="font-size: 13px;">Shiro</a> <a href="/tags/Spring-Boot/" style="font-size: 14px;">Spring Boot</a> <a href="/tags/Web/" style="font-size: 13px;">Web</a> <a href="/tags/WebSocket/" style="font-size: 13px;">WebSocket</a> <a href="/tags/demo/" style="font-size: 13.4px;">demo</a> <a href="/tags/gRPC/" style="font-size: 13px;">gRPC</a> <a href="/tags/peewee/" style="font-size: 13px;">peewee</a> <a href="/tags/sklearn/" style="font-size: 13px;">sklearn</a> <a href="/tags/%E5%B7%A5%E4%BD%9C/" style="font-size: 13px;">工作</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 13px;">爬虫</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 13.6px;">算法</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 13px;">网络</a> <a href="/tags/%E8%80%83%E7%A0%94/" style="font-size: 13.8px;">考研</a> <a href="/tags/%E8%84%9A%E6%9C%AC%E5%91%BD%E4%BB%A4/" style="font-size: 13px;">脚本命令</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 13px;">设计模式</a> <a href="/tags/%E9%83%A8%E7%BD%B2/" style="font-size: 13px;">部署</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">九月 2023</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">9</span></li></ul>
    </div>
  </div>


    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text"> 项目简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%9F%BA%E6%9C%AC%E6%80%9D%E8%B7%AF"><span class="toc-number">1.1.</span> <span class="toc-text"> 项目基本思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97"><span class="toc-number">1.2.</span> <span class="toc-text"> 系统功能模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">2.</span> <span class="toc-text"> 服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-websocket-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">2.1.</span> <span class="toc-text"> 自定义 WebSocket 服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E5%90%88-websocket-%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">2.2.</span> <span class="toc-text"> 整合 WebSocket 服务器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mybatis"><span class="toc-number">3.</span> <span class="toc-text"> Mybatis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95"><span class="toc-number">3.1.</span> <span class="toc-text"> 项目目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA"><span class="toc-number">3.2.</span> <span class="toc-text"> 项目搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#junit-4-%E6%B5%8B%E8%AF%95"><span class="toc-number">3.3.</span> <span class="toc-text"> Junit 4 测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#junit-4-%E6%95%B4%E5%90%88"><span class="toc-number">3.3.1.</span> <span class="toc-text"> Junit 4 整合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="toc-number">3.3.2.</span> <span class="toc-text"> 测试结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spring-mvc"><span class="toc-number">4.</span> <span class="toc-text"> Spring MVC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">4.1.</span> <span class="toc-text"> 项目结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA-2"><span class="toc-number">4.2.</span> <span class="toc-text"> 项目搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%B5%8B%E8%AF%95"><span class="toc-number">4.3.</span> <span class="toc-text"> 项目测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E5%90%88-swagger"><span class="toc-number">4.4.</span> <span class="toc-text"> 整合 Swagger</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97"><span class="toc-number">5.</span> <span class="toc-text"> 功能模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95"><span class="toc-number">5.1.</span> <span class="toc-text"> 用户登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">5.2.</span> <span class="toc-text"> 初始化用户信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%8B%A6%E6%88%AA%E8%AE%A4%E8%AF%81"><span class="toc-number">5.2.1.</span> <span class="toc-text"> 用户拦截认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#po-vo"><span class="toc-number">5.2.2.</span> <span class="toc-text"> PO &amp; VO</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E5%B8%83%E5%B1%80"><span class="toc-number">5.3.</span> <span class="toc-text"> 页面布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%8D%95%E8%81%8A"><span class="toc-number">5.4.</span> <span class="toc-text"> 用户单聊</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E8%81%8A%E6%B5%81%E7%A8%8B"><span class="toc-number">5.4.1.</span> <span class="toc-text"> 单聊流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E7%BB%91%E5%AE%9A"><span class="toc-number">5.4.2.</span> <span class="toc-text"> 监听绑定</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#websocket-%E5%A4%84%E7%90%86"><span class="toc-number">5.4.3.</span> <span class="toc-text"> WebSocket 处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%8C%89%E9%92%AE"><span class="toc-number">5.4.4.</span> <span class="toc-text"> 发送按钮</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%A1%86%E5%A4%84%E7%90%86"><span class="toc-number">5.4.5.</span> <span class="toc-text"> 消息框处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A5%BD%E5%8F%8B%E5%88%97%E8%A1%A8%E5%A4%84%E7%90%86"><span class="toc-number">5.4.6.</span> <span class="toc-text"> 好友列表处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%A4%84%E7%90%86"><span class="toc-number">5.4.7.</span> <span class="toc-text"> 服务器处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">5.4.8.</span> <span class="toc-text"> 测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BE%A4%E7%BB%84%E8%81%8A%E5%A4%A9"><span class="toc-number">5.5.</span> <span class="toc-text"> 群组聊天</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E8%A1%A8%E6%83%85"><span class="toc-number">5.6.</span> <span class="toc-text"> 发送表情</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%96%87%E4%BB%B6"><span class="toc-number">5.7.</span> <span class="toc-text"> 发送文件</span></a></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-后台技术/项目开发/聊天室项目" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Chatroom 简介
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2020/01/31/%E5%90%8E%E5%8F%B0%E6%8A%80%E6%9C%AF/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/%E8%81%8A%E5%A4%A9%E5%AE%A4%E9%A1%B9%E7%9B%AE/" class="article-date">
	  <time datetime="2020-01-31T04:16:27.000Z" itemprop="datePublished">2020-01-31</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/demo/" rel="tag">demo</a>
  </span>


        

        <!-- <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/01/31/%E5%90%8E%E5%8F%B0%E6%8A%80%E6%9C%AF/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/%E8%81%8A%E5%A4%A9%E5%AE%A4%E9%A1%B9%E7%9B%AE/#comments" class="article-comment-link">评论</a></span> -->
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>一个网页版的线上聊天室</p>
<span id="more"></span>
<h2 id="项目简介"><a class="markdownIt-Anchor" href="#项目简介"></a> 项目简介</h2>
<h3 id="项目基本思路"><a class="markdownIt-Anchor" href="#项目基本思路"></a> 项目基本思路</h3>
<p>此项目以 Tomcat 作为核心服务器用于处理客户登录、个人信息管理等 HTTP 类型的请求，端口号：8080。</p>
<p>在 Tomcat 服务器中另开一个线程启动 Netty WebSocket 服务器用于处理用户消息通信的 WebSocket 类型的请求，端口号：3333。</p>
<p><img src="/img/2020/01/Chatroom/ServerModel.PNG" alt="" /></p>
<p>用户登录后：</p>
<ul>
<li>Tomcat 服务器会返回用户的个人信息，同时更新记录在线用户，<strong>根据用户 id 建立一条 WebSocket 连接并保存在后端以便进行实时通信</strong>。</li>
<li>浏览器将维持一个 Session 对象来保持登录状态（30 min）。</li>
</ul>
<p>用户与用户进行通信：</p>
<ul>
<li>服务器根据收到的消息内容中的对话方的用户 id 找到保存的 WebSocket 连接，通过该连接发送消息。</li>
</ul>
<p>用户退出：</p>
<ul>
<li>释放用户的 WebSocket 连接。</li>
<li>清空用户在 Session 对象中的登陆状态。</li>
</ul>
<h3 id="系统功能模块"><a class="markdownIt-Anchor" href="#系统功能模块"></a> 系统功能模块</h3>
<p>登录模块：用户登录、用户注销。</p>
<p>聊天管理模块：单条消息发送、群组消息发送。（消息：文本、文件）</p>
<h2 id="服务器"><a class="markdownIt-Anchor" href="#服务器"></a> 服务器</h2>
<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- netty4 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.2.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>WebSocket<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">optimize</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optimize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="自定义-websocket-服务器"><a class="markdownIt-Anchor" href="#自定义-websocket-服务器"></a> 自定义 WebSocket 服务器</h3>
<p>服务器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(WebSocketServer.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EventLoopGroup bossGroup;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EventLoopGroup workerGroup;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ServerBootstrap serverBootstrap;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// port 和 childChannelHandler 用 Xml 的方式配置，需要 getter/setter 方法</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> ChannelHandler childChannelHandler;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ChannelFuture serverChannelFuture;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebSocketServer</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 启动Netty Websocket服务器</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            serverBootstrap.group(bossGroup, workerGroup) <span class="comment">// boss 负责客户端的 TCP 连接请求  worker 负责与客户端之前的读写操作</span></span><br><span class="line">                .channel(NioServerSocketChannel.class) <span class="comment">// 配置客户端的 channel 类型</span></span><br><span class="line">                .option(ChannelOption.SO_BACKLOG, <span class="number">1024</span>) <span class="comment">// 设置请求队列的长度</span></span><br><span class="line">                .option(ChannelOption.TCP_NODELAY, <span class="literal">true</span>) <span class="comment">// 降低延迟</span></span><br><span class="line">                .childOption(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>) <span class="comment">// 两小时无活动检测心跳</span></span><br><span class="line">                .childOption(ChannelOption.RCVBUF_ALLOCATOR, <span class="keyword">new</span> <span class="title class_">FixedRecvByteBufAllocator</span>(<span class="number">592048</span>)) <span class="comment">// 配置固定长度接收缓存区分配器</span></span><br><span class="line">                .childHandler(childChannelHandler); <span class="comment">// 绑定 I/O 事件的处理类，WebSocketChildChannelHandler 中定义</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            </span><br><span class="line">            logger.info(<span class="string">&quot;Netty Websocket服务器启动完成，耗时 &quot;</span> + (end - begin) + <span class="string">&quot; ms，已绑定端口 &quot;</span> + port + <span class="string">&quot; 阻塞式等候客户端连接&quot;</span>);</span><br><span class="line"></span><br><span class="line">            serverChannelFuture = serverBootstrap.bind(port).sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.info(e.getMessage());</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 关闭 WebSocket 服务器</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span>&#123;</span><br><span class="line">        serverChannelFuture.channel().close();</span><br><span class="line">        Future&lt;?&gt; bossGroupFuture = bossGroup.shutdownGracefully();</span><br><span class="line">        Future&lt;?&gt; workerGroupFuture = workerGroup.shutdownGracefully();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bossGroupFuture.await();</span><br><span class="line">            workerGroupFuture.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ignore) &#123;</span><br><span class="line">            ignore.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ChannelHandler <span class="title function_">getChildChannelHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> childChannelHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setChildChannelHandler</span><span class="params">(ChannelHandler childChannelHandler)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.childChannelHandler = childChannelHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPort</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPort</span><span class="params">(<span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据处理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketChildChannelHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;webSocketServerHandler&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChannelHandler webSocketServerHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;httpRequestHandler&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChannelHandler httpRequestHandler;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 初始化通道，装载上所需要的处理器</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ch.pipeline().addLast(<span class="string">&quot;http-codec&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpServerCodec</span>()); <span class="comment">// HTTP编码解码器</span></span><br><span class="line">        ch.pipeline().addLast(<span class="string">&quot;aggregator&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">65536</span>)); <span class="comment">// 合并分批次过来的 HTTP 报文，合并后 Handler拿到的将是一个完整的 HTTP 报文</span></span><br><span class="line">        ch.pipeline().addLast(<span class="string">&quot;http-chunked&quot;</span>, <span class="keyword">new</span> <span class="title class_">ChunkedWriteHandler</span>()); <span class="comment">// 方便大文件传输，不过实质上都是短的文本数据</span></span><br><span class="line">        ch.pipeline().addLast(<span class="string">&quot;http-handler&quot;</span>, httpRequestHandler); <span class="comment">// 绑定自定义的 Http 请求处理器</span></span><br><span class="line">        ch.pipeline().addLast(<span class="string">&quot;websocket-handler&quot;</span>,webSocketServerHandler); <span class="comment">// 绑定自定义的 WebSocket 请求处理器</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义 Http 请求处理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Sharable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpRequestHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> FullHttpRequest) &#123;</span><br><span class="line">            <span class="comment">// 处理 Http 请求</span></span><br><span class="line">            handleHttpRequest(ctx, (FullHttpRequest) msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> WebSocketFrame) &#123;</span><br><span class="line">            <span class="comment">// retain() 增加 ByteBuf 的引用计数，fireChannelRead 通知需要继续调用链表后面的 channelRead</span></span><br><span class="line">            ctx.fireChannelRead(((WebSocketFrame) msg).retain());</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理 Http 请求，主要是完成 HTTP 协议到 Websocket 协议的升级</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleHttpRequest</span><span class="params">(ChannelHandlerContext ctx, FullHttpRequest req)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!req.decoderResult().isSuccess()) &#123;</span><br><span class="line">            sendHttpResponse(ctx, req, <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1, HttpResponseStatus.BAD_REQUEST));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// 构造握手工厂</span></span><br><span class="line">        <span class="type">WebSocketServerHandshakerFactory</span> <span class="variable">wsFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebSocketServerHandshakerFactory</span>(</span><br><span class="line">                <span class="string">&quot;ws:/&quot;</span> + ctx.channel() + <span class="string">&quot;/websocket&quot;</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 创建握手处理类</span></span><br><span class="line">        <span class="type">WebSocketServerHandshaker</span> <span class="variable">handshaker</span> <span class="operator">=</span> wsFactory.newHandshaker(req);</span><br><span class="line">        <span class="comment">// 将此连接保存到一个全局 Map 中，用户退出登陆时要移除此处理类</span></span><br><span class="line">        Constant.webSocketHandshakerMap.put(ctx.channel().id().asLongText(), handshaker);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (handshaker == <span class="literal">null</span>) &#123;</span><br><span class="line">            WebSocketServerHandshakerFactory.sendUnsupportedVersionResponse(ctx.channel());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 构造握手响应消息返回给客户端</span></span><br><span class="line">            <span class="comment">// 将 WebSocket 相关的编码和解码类动态添加到 ChannelPipeline 中用于 WebSocket 消息的编解码</span></span><br><span class="line">            handshaker.handshake(ctx.channel(), req);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendHttpResponse</span><span class="params">(ChannelHandlerContext ctx, FullHttpRequest req, DefaultFullHttpResponse res)</span> &#123;</span><br><span class="line">        <span class="comment">// 返回应答给客户端</span></span><br><span class="line">        <span class="keyword">if</span> (res.status().code() != <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.copiedBuffer(res.status().toString(), CharsetUtil.UTF_8);</span><br><span class="line">            res.content().writeBytes(buf);</span><br><span class="line">            buf.release();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果是非Keep-Alive，关闭连接</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">keepAlive</span> <span class="operator">=</span> HttpUtil.isKeepAlive(req);</span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> ctx.channel().writeAndFlush(res);</span><br><span class="line">        <span class="keyword">if</span> (!keepAlive) &#123;</span><br><span class="line">            f.addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义 WebSocket 请求处理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Sharable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;WebSocketFrame&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(WebSocketServerHandler.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ChatService chatService;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 对 WebSocket 的请求消息进行处理</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, WebSocketFrame msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        handlerWebSocketFrame(ctx, msg);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlerWebSocketFrame</span><span class="params">(ChannelHandlerContext ctx, WebSocketFrame frame)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 关闭请求</span></span><br><span class="line">        <span class="keyword">if</span> (frame <span class="keyword">instanceof</span> CloseWebSocketFrame) &#123;</span><br><span class="line">            <span class="type">WebSocketServerHandshaker</span> <span class="variable">handshaker</span> <span class="operator">=</span> </span><br><span class="line">                    Constant.webSocketHandshakerMap.get(ctx.channel().id().asLongText());</span><br><span class="line">            <span class="keyword">if</span> (handshaker == <span class="literal">null</span>) &#123;</span><br><span class="line">                sendErrorMessage(ctx, <span class="string">&quot;不存在的客户端连接！&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                handshaker.close(ctx.channel(), (CloseWebSocketFrame) frame.retain());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ping请求</span></span><br><span class="line">        <span class="keyword">if</span> (frame <span class="keyword">instanceof</span> PingWebSocketFrame) &#123;</span><br><span class="line">            ctx.channel().write(<span class="keyword">new</span> <span class="title class_">PongWebSocketFrame</span>(frame.content().retain()));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 只支持文本格式，不支持二进制消息</span></span><br><span class="line">        <span class="keyword">if</span> (!(frame <span class="keyword">instanceof</span> TextWebSocketFrame)) &#123;</span><br><span class="line">            sendErrorMessage(ctx, <span class="string">&quot;仅支持文本(Text)格式，不支持二进制消息&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 客服端发送过来的消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">request</span> <span class="operator">=</span> ((TextWebSocketFrame)frame).text();</span><br><span class="line">        LOGGER.info(<span class="string">&quot;服务端收到新信息：&quot;</span> + request);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">param</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            param = JSONObject.parseObject(request);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            sendErrorMessage(ctx, <span class="string">&quot;JSON字符串转换出错！&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (param == <span class="literal">null</span>) &#123;</span><br><span class="line">            sendErrorMessage(ctx, <span class="string">&quot;参数为空！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> (String) param.get(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;REGISTER&quot;</span>:</span><br><span class="line">                chatService.register(param, ctx);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;SINGLE_SENDING&quot;</span>:</span><br><span class="line">                chatService.singleSend(param, ctx);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;GROUP_SENDING&quot;</span>:</span><br><span class="line">                chatService.groupSend(param, ctx);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;FILE_MSG_SINGLE_SENDING&quot;</span>:</span><br><span class="line">                chatService.FileMsgSingleSend(param, ctx);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;FILE_MSG_GROUP_SENDING&quot;</span>:</span><br><span class="line">                chatService.FileMsgGroupSend(param, ctx);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                chatService.typeError(ctx);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 客户端断开连接</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        chatService.remove(ctx);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">	<span class="comment">// 出现异常关闭通道</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendErrorMessage</span><span class="params">(ChannelHandlerContext ctx, String errorMsg)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseJson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>()</span><br><span class="line">                .error(errorMsg)</span><br><span class="line">                .toString();</span><br><span class="line">        ctx.channel().writeAndFlush(<span class="keyword">new</span> <span class="title class_">TextWebSocketFrame</span>(responseJson));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="整合-websocket-服务器"><a class="markdownIt-Anchor" href="#整合-websocket-服务器"></a> 整合 WebSocket 服务器</h3>
<p>先来看看项目的服务器构成。</p>
<p><img src="http://welab-wingo.gitee.io/Image/2020/01/Chatroom/ServerModel.PNG" alt="" /></p>
<blockquote>
<p>Tomcat 是一个免费的开放源代码的 Servlet 容器</p>
</blockquote>
<p>回顾一下 Servlet 的生命周期。</p>
<img src="http://gudtwingo.gitee.io/Image/2020/02/ChatRoom/ServletLife.PNG" style="zoom:80%;" />
<p>要把 Netty WebSocket 服务器整合到 Tomcat 服务器中，那么就需要在 Servlet 初始化之前告诉其所需要进行的操作。写一个<code>@PostConstruct</code>注解方法开启一个独立线程用于启动 Netty WebSocket 服务器；并且写一个<code>@PreDestory</code>注解方法在 Servlet 完全关闭之前关闭 WebSocket 服务器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Scope(&quot;singleton&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(AppContext.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebSocketServer webSocketServer;</span><br><span class="line">    <span class="keyword">private</span> Thread nettyThread;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        nettyThread = <span class="keyword">new</span> <span class="title class_">Thread</span>(webSocketServer);</span><br><span class="line">        logger.info(<span class="string">&quot;开启独立线程，启动 Netty WebSocket 服务器...&quot;</span>);</span><br><span class="line">        nettyThread.start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;正在释放Netty Websocket相关连接...&quot;</span>);</span><br><span class="line">        webSocketServer.close();</span><br><span class="line">        logger.info(<span class="string">&quot;正在关闭Netty Websocket服务器线程...&quot;</span>);</span><br><span class="line">        nettyThread.stop();</span><br><span class="line">        logger.info(<span class="string">&quot;系统成功关闭！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在执行这个方法之前，Tomcat 已经加载完配置文件，这里的 WebSocket 服务器是通过<code>@AutoWired</code>装载进来的，也就是说 WebSocket 需要在 Spring 容器中注册成为一个 Bean。</p>
<p>ApplicationContext-netty.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 扫描关于 Netty Websocket 的包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.wingo.web.websocket&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 把 Netty 的一些类服务器注册到 Spring，方便处理和扩展 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 用于处理客户端连接请求 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;bossGroup&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.netty.channel.nio.NioEventLoopGroup&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 用于处理客户端 I/O 操作 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;workerGroup&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.netty.channel.nio.NioEventLoopGroup&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 服务器启动引导类 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;serverBootstrap&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.netty.bootstrap.ServerBootstrap&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 自定义的Netty Websocket服务器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;webSocketServer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.wingo.web.websocket.WebSocketServer&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;port&quot;</span> <span class="attr">value</span>=<span class="string">&quot;3333&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;childChannelHandler&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;webSocketChildChannelHandler&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="mybatis"><a class="markdownIt-Anchor" href="#mybatis"></a> Mybatis</h2>
<h3 id="项目目录"><a class="markdownIt-Anchor" href="#项目目录"></a> 项目目录</h3>
<ul>
<li>Model：
<ul>
<li>po/User.java 用户实体</li>
</ul>
</li>
<li>Dao
<ul>
<li>UserDao.java 用户数据访问对象</li>
</ul>
</li>
<li>Service
<ul>
<li>UserService.java 用户业务逻辑</li>
<li>UserServiceImpl.java</li>
</ul>
</li>
<li>Xml
<ul>
<li>UserMapper.xml 持久层 / 对象关系映射文件</li>
<li>ApplicationContext-dao.xml</li>
<li>ApplicationContext-service.xml</li>
<li>MybatisConfig.xml</li>
<li>pom.xml</li>
</ul>
</li>
<li>Properties
<ul>
<li>jdbc.properties 数据库配置文件</li>
</ul>
</li>
</ul>
<p><img src="http://gudtwingo.gitee.io/Image/2020/02/ChatRoom/SpringMybatiscatalog.PNG" alt="" /></p>
<h3 id="项目搭建"><a class="markdownIt-Anchor" href="#项目搭建"></a> 项目搭建</h3>
<p>pom.xml 添加 Mybatis 相关依赖包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- MySQL --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- c3p0 连接池 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Mybatis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>数据库的建立</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">  `user_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `user_name` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`user_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">2</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8</span><br></pre></td></tr></table></figure>
<p>用户实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getUserId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserId</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUserName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserName</span><span class="params">(String userName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;userId=&#x27;&quot;</span> + userId + <span class="string">&#x27;/&#x27;</span><span class="string">&#x27; +</span></span><br><span class="line"><span class="string">            &quot;, username=&#x27;</span><span class="string">&quot; + userName + &#x27;/&#x27;&#x27; +</span></span><br><span class="line"><span class="string">            &quot;</span>, password=<span class="string">&#x27;&quot; + password + &#x27;</span>/<span class="string">&#x27;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据访问类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 保存用户信息</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">(User user)</span>;</span><br><span class="line">    <span class="comment">// 通过 id 取得用户信息</span></span><br><span class="line">    User <span class="title function_">queryById</span><span class="params">(<span class="type">long</span> user)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对象 / 持久层映射文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;wingo.dao.UserDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;saveUser&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;wingo.model.po.User&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;userId&quot;</span>&gt;</span></span><br><span class="line">        INSERT INTO </span><br><span class="line">        user (user_name,password)</span><br><span class="line">        VALUES </span><br><span class="line">        (#&#123;userName&#125;,#&#123;password&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;queryById&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;long&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;wingo.model.po.User&quot;</span> &gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 具体的sql --&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">        user_id,user_name,password</span><br><span class="line">        FROM</span><br><span class="line">        user</span><br><span class="line">        WHERE</span><br><span class="line">        user_id = #&#123;userId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>业务逻辑类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">(User user)</span>;</span><br><span class="line">    User <span class="title function_">queryById</span><span class="params">(<span class="type">long</span> userId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>业务逻辑类的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger= LoggerFactory.getLogger(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        userDao.saveUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">queryById</span><span class="params">(<span class="type">long</span> userId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.queryById(userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据库信息配置 jdbc.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jdbc.driver</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">jdbc.url</span>=<span class="string">jdbc:mysql://127.0.0.1:3306/nettychatroom?useUnicode=true&amp;characterEncoding=utf8</span></span><br><span class="line"><span class="attr">jdbc.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">jdbc.password</span>= <span class="string">123456</span></span><br></pre></td></tr></table></figure>
<p>Mybatis 配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置全局属性 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 使用jdbc的getGeneratedKeys获取数据库自增主键值 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;useGeneratedKeys&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 使用列别名替换列名 默认:true --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;useColumnLabel&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 开启驼峰命名转换:Table&#123;create_time&#125; -&gt; Entity&#123;createTime&#125; --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;mapUnderscoreToCamelCase&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 开启控制台打印 SQL 语句 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;logImpl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;STDOUT_LOGGING&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>数据访问层上下文配置 ApplicationContext-dao.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置整合mybatis过程 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1.配置数据库相关参数properties的属性：$&#123;url&#125; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:jdbc.properties&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 2.数据库连接池 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置连接池属性 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.driver&#125;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- c3p0连接池的私有属性 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxPoolSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;30&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minPoolSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 关闭连接后不自动commit --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;autoCommitOnClose&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 获取连接超时时间 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;checkoutTimeout&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10000&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 当获取连接失败重试次数 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;acquireRetryAttempts&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 3.配置SqlSessionFactory对象 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注入数据库连接池 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置MyBaties全局配置文件:mybatis-config.xml --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;configLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:MybatisConfig.xml&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 扫描entity包，使用别名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;typeAliasesPackage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;wingo.dao&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 扫描sql配置文件:mapper需要的xml文件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapperLocations&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:mapper/*.xml&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 4.配置扫描Dao接口包，动态实现Dao接口，注入到spring容器中 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注入sqlSessionFactory --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqlSessionFactoryBeanName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 给出需要扫描Dao接口包 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;basePackage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;wingo.dao&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>业务逻辑层上下文配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="string"><span class="tag">                           http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 扫描service包下所有使用注解的类型 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;wingo.service&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置事务管理器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注入数据库连接池 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置基于注解的声明式事务 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:annotation-driven</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="junit-4-测试"><a class="markdownIt-Anchor" href="#junit-4-测试"></a> Junit 4 测试</h3>
<h4 id="junit-4-整合"><a class="markdownIt-Anchor" href="#junit-4-整合"></a> Junit 4 整合</h4>
<p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Junit --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;scope&gt;test&lt;/scope&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>测试基类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span> <span class="comment">//使用junit4进行测试</span></span><br><span class="line"><span class="meta">@ContextConfiguration(locations=&#123;</span></span><br><span class="line"><span class="meta">    &quot;classpath:spring/ApplicationContext-dao.xml&quot;,</span></span><br><span class="line"><span class="meta">    &quot;classpath:spring/ApplicationContext-service.xml&quot;</span></span><br><span class="line"><span class="meta">&#125;)</span> <span class="comment">//加载配置文件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseJunit4Test</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserTest</span> <span class="keyword">extends</span> <span class="title class_">BaseJunit4Test</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Transactional</span>   <span class="comment">//标明此方法需使用事务</span></span><br><span class="line">    <span class="meta">@Rollback(false)</span>  <span class="comment">//标明使用完此方法后事务不回滚,true时为回滚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;测试Spring整合Junit4进行单元测试&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// User user = new User();</span></span><br><span class="line">        <span class="comment">// user.setUserName(&quot;test1&quot;);</span></span><br><span class="line">        <span class="comment">// user.setPassword(&quot;111&quot;);</span></span><br><span class="line">        <span class="comment">// userService.saveUser(user);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.queryById(<span class="number">1</span>);</span><br><span class="line">        System.out.println(user.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="测试结果"><a class="markdownIt-Anchor" href="#测试结果"></a> 测试结果</h4>
<p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/SpringMybatisTest01.PNG" alt="" /></p>
<h2 id="spring-mvc"><a class="markdownIt-Anchor" href="#spring-mvc"></a> Spring MVC</h2>
<img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/SpringMVCFlow.jpg" style="zoom: 50%;" />
<h3 id="项目结构"><a class="markdownIt-Anchor" href="#项目结构"></a> 项目结构</h3>
<ul>
<li>
<p>View：</p>
<ul>
<li>longin.html 用户登录页面</li>
<li>chatroom.html 聊天室页面</li>
</ul>
</li>
<li>
<p>Controller</p>
<ul>
<li>UserController.java</li>
<li>LoginController.java</li>
</ul>
</li>
<li>
<p>Xml</p>
<ul>
<li>ApplicationContext-mvc.xml</li>
<li>web.xml</li>
<li>pom.xml</li>
</ul>
</li>
</ul>
<p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/SpringMVCatalog.PNG" alt="" /></p>
<h3 id="项目搭建-2"><a class="markdownIt-Anchor" href="#项目搭建-2"></a> 项目搭建</h3>
<p>pom.xml 添加 Spring 全家桶依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-orm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-tx<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-expression<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>web.xml 中将请求交给 SpringMVC 处理</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 前端控制器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>SpringMVC<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet</span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring/ApplicationContext-mvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>SpringMVC<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>对 SpringMVC 进行配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- MVC 负责扫描 Controller --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;wingo.web.controller&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 启动 Spring MVC 的注解功能，完成请求和注解POJO的映射,解决 @ResponseBody 乱码问题 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 需要在 annotation-driven 之前,否则乱码问题同样无法解决 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;messageConverters&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.http.converter.StringHttpMessageConverter&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;supportedMediaTypes&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">value</span>&gt;</span>text/html;charset=UTF-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 开启 MVC 的注解式配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 视图解释类 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">&quot;viewResolver&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/views/&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.html&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 设置不拦截静态文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">location</span>=<span class="string">&quot;/WEB-INF/views/&quot;</span> <span class="attr">mapping</span>=<span class="string">&quot;/WEB-INF/views/**&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">location</span>=<span class="string">&quot;/static/&quot;</span> <span class="attr">mapping</span>=<span class="string">&quot;/static/**/**&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">location</span>=<span class="string">&quot;/UploadFile/&quot;</span> <span class="attr">mapping</span>=<span class="string">&quot;/UploadFile/**&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>编写控制器方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="comment">// 跳转到登陆页面</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &#123;&quot;login&quot;, &quot;/&quot;&#125;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toLogin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatroomController</span> &#123;</span><br><span class="line">	<span class="comment">// 登录成功后的跳转页面</span></span><br><span class="line">    <span class="meta">@RequestMapping(method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toChatroom</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;chatroom&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="项目测试"><a class="markdownIt-Anchor" href="#项目测试"></a> 项目测试</h3>
<p>控制台输出</p>
<p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/SpringMVCInit.PNG" alt="" /></p>
<p><code>@RequestMapping(value = &#123;&quot;login&quot;, &quot;/&quot;&#125;, method = RequestMethod.GET)</code></p>
<p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/SpringMVCLogin.PNG" alt="" /></p>
<h3 id="整合-swagger"><a class="markdownIt-Anchor" href="#整合-swagger"></a> 整合 Swagger</h3>
<p>Swagger 是一款 RESTFUL 接口的文档在线自动生成 + 功能测试功能软件。</p>
<blockquote>
<p>@Api ：修饰整个类，描述Controller的作用；<br />
@ApiOperation ：描述一个类的一个方法，或者说一个接口；<br />
@ApiParam ：单个参数描述；用在方法参数上<br />
@ApiModel ：用对象来接收参数；<br />
@ApiProperty ：用对象接收参数时，描述对象的一个字段；<br />
@ApiResponse ：HTTP响应其中1个描述；<br />
@ApiResponses ：HTTP响应整体描述；<br />
@ApiIgnore ：使用该注解忽略这个API；<br />
@ApiError ：发生错误返回的信息；<br />
@ApiImplicitParam ：一个请求参数：用在方法上 。<br />
@ApiImplicitParams ：多个请求参数：用在方法上。</p>
</blockquote>
<p>引入依赖包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Swagger 可帮助开发人员设计，构建，记录和使用 RESTful Web 服务 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Jackson 包，配合 Spring @ResponseBody 注解，以及 Json 工具包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置 Swagger</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableSwagger2</span> <span class="comment">//使 Swagger2 生效</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &#123;&quot;wingo.web.controller&quot;&#125;)</span> <span class="comment">//需要扫描的controller包路径</span></span><br><span class="line"><span class="meta">@Configurable</span> <span class="comment">//配置注解，自动在本类上下文加载一些环境变量信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfig</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurationSupport</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//RestApiConfig</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">buildDocket</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">            .apiInfo(buildApiInf())</span><br><span class="line">            .select()</span><br><span class="line">            .apis(RequestHandlerSelectors.basePackage(<span class="string">&quot;wingo.web.controller&quot;</span>))<span class="comment">//controller路径</span></span><br><span class="line">            .paths(PathSelectors.any())</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApiInfo <span class="title function_">buildApiInf</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">            .title(<span class="string">&quot;Wingo&#x27;s Swagger&quot;</span>)</span><br><span class="line">            .description(<span class="string">&quot;Web Restful 测试&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Spring 加载 SwaggerConfig</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 加载 SwaggerConfig --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;springfox.documentation.swagger2.configuration.Swagger2DocumentationConfiguration&quot;</span> <span class="attr">id</span>=<span class="string">&quot;swagger2Config&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 不拦截所需静态文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">mapping</span>=<span class="string">&quot;swagger-ui.html&quot;</span> <span class="attr">location</span>=<span class="string">&quot;classpath:/META-INF/resources/&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">mapping</span>=<span class="string">&quot;/webjars/**&quot;</span> <span class="attr">location</span>=<span class="string">&quot;classpath:/META-INF/resources/webjars/&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>在需要标注的控制器类方法上添加注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(value=&quot;/swagger&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestSwaggerController</span> &#123;</span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;测试专用&quot;, notes = &quot;返回一个 JSON 字符串&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value=&quot;/test&quot;,method= RequestMethod.GET)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setUserId((<span class="type">long</span>) <span class="number">1</span>);</span><br><span class="line">        user.setUserName(<span class="string">&quot;中文测试&quot;</span>);</span><br><span class="line">        user.setPassword(<span class="string">&quot;111&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            str = mapper.writeValueAsString(user);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问：[项目根目录]/swagger-ui.html</p>
<p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/SwaggerTest01.PNG" alt="" /></p>
<p>点击 Try it out 进行请求的发送。</p>
<p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/SwaggerTest02.PNG" alt="" /></p>
<p>成功请求并的到响应。</p>
<h2 id="功能模块"><a class="markdownIt-Anchor" href="#功能模块"></a> 功能模块</h2>
<p>数据库结构</p>
<p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/Database.PNG" alt="" /></p>
<p><strong>基于 Spring 注解式开发</strong></p>
<p>前后端分离，返回 Json 的视图对象类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResponseJson</span> <span class="keyword">extends</span> <span class="title class_">HashMap</span>&lt;String, Object&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">SUCCESS_STATUS</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">ERROR_STATUS</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUCCESS_MSG</span> <span class="operator">=</span> <span class="string">&quot;一切正常&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResponseJson</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResponseJson</span><span class="params">(<span class="type">int</span> code)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        setStatus(code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResponseJson</span><span class="params">(HttpStatus status)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        setStatus(status.value());</span><br><span class="line">        setMsg(status.getReasonPhrase());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseJson <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        put(<span class="string">&quot;msg&quot;</span>, SUCCESS_MSG);</span><br><span class="line">        put(<span class="string">&quot;status&quot;</span>, SUCCESS_STATUS);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseJson <span class="title function_">success</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        put(<span class="string">&quot;msg&quot;</span>, msg);</span><br><span class="line">        put(<span class="string">&quot;status&quot;</span>, SUCCESS_STATUS);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseJson <span class="title function_">error</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        put(<span class="string">&quot;msg&quot;</span>, msg);</span><br><span class="line">        put(<span class="string">&quot;status&quot;</span>, ERROR_STATUS);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseJson <span class="title function_">setData</span><span class="params">(String key, Object obj)</span> &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        HashMap&lt;String, Object&gt; data = (HashMap&lt;String, Object&gt;) get(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="literal">null</span>) &#123;</span><br><span class="line">            data = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">            put(<span class="string">&quot;data&quot;</span>, data);</span><br><span class="line">        &#125;</span><br><span class="line">        data.put(key, obj);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseJson <span class="title function_">setStatus</span><span class="params">(<span class="type">int</span> status)</span> &#123;</span><br><span class="line">        put(<span class="string">&quot;status&quot;</span>, status);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseJson <span class="title function_">setMsg</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        put(<span class="string">&quot;msg&quot;</span>, msg);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseJson <span class="title function_">setValue</span><span class="params">(String key, Object val)</span> &#123;</span><br><span class="line">        put(key, val);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回JSON字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONObject.toJSONString(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>用来存放 Netty WebSocket 连接信息的常量类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Constant</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一个 userId 对应一个 Session</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_TOKEN</span> <span class="operator">=</span> <span class="string">&quot;userId&quot;</span>;</span><br><span class="line">	<span class="comment">// 用于保存 Http 升级 WebSocket 后的握手实例</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, WebSocketServerHandshaker&gt; webSocketHandshakerMap =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, WebSocketServerHandshaker&gt;();</span><br><span class="line">	<span class="comment">// 用于保存已登录的用户的通道信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, ChannelHandlerContext&gt; onlineUserMap = </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, ChannelHandlerContext&gt;();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="用户登录"><a class="markdownIt-Anchor" href="#用户登录"></a> 用户登录</h3>
<p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/LoginFlow.PNG" alt="" /></p>
<p>User 👉 实体类，与数据库表 user 向对应</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String avatarUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略了 Getter Setter toString 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserDao、UserMapper👉 通过用户输入的用户名到数据库中找到此用户的用户信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User <span class="title function_">getByUsername</span><span class="params">(String username)</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getByUsername&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.wingo.model.po.User&quot;</span> &gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 具体的sql --&gt;</span></span><br><span class="line">    SELECT</span><br><span class="line">    	user_id, username, password</span><br><span class="line">    FROM</span><br><span class="line">    	user</span><br><span class="line">    WHERE</span><br><span class="line">    	username = #&#123;username&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>SecurityService、SecurityServiceImpl 👉 实现登录的业务逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ResponseJson <span class="title function_">login</span><span class="params">(String username, String password, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getByUsername(username);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>().error(<span class="string">&quot;不存在该用户名&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!user.getPassword().equals(password)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>().error(<span class="string">&quot;密码不正确&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将已登录的用户的 userId 保存在 Session 中</span></span><br><span class="line">    session.setAttribute(Constant.USER_TOKEN, user.getUserId());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>().success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SecurityController 👉 URL映射以及前后端数据交互</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;login&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ResponseJson <span class="title function_">login</span><span class="params">(HttpSession session, <span class="meta">@RequestParam</span> String username, <span class="meta">@RequestParam</span> String password)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> securityService.login(username, password, session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用户点击登录按钮后，发送 Ajax 请求进行用户验证，验证通过后跳转到 chatroom 页面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        type : <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        url : <span class="string">&#x27;login&#x27;</span>,</span><br><span class="line">        <span class="attr">dataType</span>: <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">        data : &#123;</span><br><span class="line">            <span class="attr">username</span>: $(<span class="string">&quot;#username&quot;</span>).<span class="title function_">val</span>(),</span><br><span class="line">            <span class="attr">password</span>: $(<span class="string">&quot;#password&quot;</span>).<span class="title function_">val</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">async</span> : <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (data.<span class="property">status</span> == <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span>=<span class="string">&quot;chatroom&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">alert</span>(data.<span class="property">msg</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h3 id="初始化用户信息"><a class="markdownIt-Anchor" href="#初始化用户信息"></a> 初始化用户信息</h3>
<p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/ChatroomFlow.PNG" alt="" /></p>
<h4 id="用户拦截认证"><a class="markdownIt-Anchor" href="#用户拦截认证"></a> 用户拦截认证</h4>
<p>UserAuthInteceptor 👉 检测用户是否登录并设置资源访问权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserAuthInteceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span><br><span class="line">        <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">userToken</span> <span class="operator">=</span> session.getAttribute(Constant.USER_TOKEN);</span><br><span class="line">        <span class="keyword">if</span> (userToken == <span class="literal">null</span>) &#123;</span><br><span class="line">            response.sendRedirect(<span class="string">&quot;login&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler,</span></span><br><span class="line"><span class="params">                           ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 允许所有资源都可以访问资源</span></span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">// 表示是否可以将对请求的响应暴露给页面</span></span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Credentials&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置 Spring MVC 对 chatoom 页面的访问请求进行拦截认证</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 用户认证拦截器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/chatroom/**&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.wingo.web.interceptor.UserAuthInteceptor&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="po-vo"><a class="markdownIt-Anchor" href="#po-vo"></a> PO &amp; VO</h4>
<p>在返回给用户的信息中，除了用户的个人信息，还需要用户的好友列表信息以及群聊列表信息。创建一个 VO 类用于保存前端所需要的所有信息。</p>
<p><img src="http://welab-wingo.gitee.io/Image/2020/02/ChatRoom/POVO.PNG" alt="" /></p>
<p>UserInfo 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String avatarUrl;</span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; friendList; <span class="comment">// 好友列表信息</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Chatgroup&gt; groupList; <span class="comment">// 群聊信息</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造器方法便于实例化</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Chatgroup 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// group 为 MySQL 的关键字，不可使用</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Chatgroup</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long groupId;</span><br><span class="line">    <span class="keyword">private</span> String groupName;</span><br><span class="line">    <span class="keyword">private</span> String groupAvatarUrl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GroupInfo 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupInfo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long groupId;</span><br><span class="line">    <span class="keyword">private</span> String groupName;</span><br><span class="line">    <span class="keyword">private</span> String groupAvatarUrl;</span><br><span class="line">    <span class="keyword">private</span> List&lt;User&gt; members;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造器方法便于实例化</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ChatroomController 👉 通过 userId 获取用户的信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/get_userinfo&quot;, method = RequestMethod.POST)</span> </span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ResponseJson <span class="title function_">getUserInfo</span><span class="params">(HttpSession session)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">userId</span> <span class="operator">=</span> session.getAttribute(Constant.USER_TOKEN);</span><br><span class="line">    System.out.println(<span class="string">&quot;Session 中的 userId = &quot;</span> + userId);</span><br><span class="line">    <span class="keyword">return</span> userService.getByUserId(String.valueOf(userId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserChatRelationDao userChatRelationDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GroupDao groupDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ResponseJson <span class="title function_">getByUserId</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.getByUserId(userId);</span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInfo</span>(</span><br><span class="line">            user.getUserId(),</span><br><span class="line">            user.getUsername(),</span><br><span class="line">            user.getPassword(),</span><br><span class="line">            user.getAvatarUrl()</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// friendList 构造</span></span><br><span class="line">        List&lt;String&gt; friendsId = userChatRelationDao.getUserFriendsIdByUserId(userId);</span><br><span class="line">        List&lt;User&gt; friends = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;User&gt;();</span><br><span class="line">        <span class="keyword">for</span>(String friendId : friendsId)&#123;</span><br><span class="line">            <span class="type">User</span> <span class="variable">friend</span> <span class="operator">=</span> userDao.getByUserId(friendId);</span><br><span class="line">            friends.add(friend);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// groupList 构造</span></span><br><span class="line">        List&lt;String&gt; groupsId = userChatRelationDao.getGroupsIdByUserId(userId);</span><br><span class="line">        List&lt;Chatgroup&gt; groups = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Chatgroup&gt;();</span><br><span class="line">        <span class="keyword">for</span>(String groupId : groupsId)&#123;</span><br><span class="line">            <span class="type">Chatgroup</span> <span class="variable">group</span> <span class="operator">=</span> groupDao.getByGroupId(groupId);</span><br><span class="line">            groups.add(group);</span><br><span class="line">        &#125;</span><br><span class="line">        userInfo.setGroupList(groups);</span><br><span class="line">        userInfo.setFriendList(friends);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>().success()</span><br><span class="line">            .setData(<span class="string">&quot;userInfo&quot;</span>, userInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 Swagger 模拟请求取得返回的 Json 数据。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;一切正常&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;userInfo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;avatarUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;static/img/avatar/Member001.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;friendList&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;avatarUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;static/img/avatar/Member001.jpg&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test3&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;avatarUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;static/img/avatar/Member001.jpg&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test4&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;avatarUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;static/img/avatar/Member001.jpg&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;groupList&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;groupId&quot;</span><span class="punctuation">:</span> <span class="number">1000</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;groupName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Group1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;groupAvatarUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;static/img/avatar/Group01.jpg&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">200</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>用户信息初始化完成。</p>
<h3 id="页面布局"><a class="markdownIt-Anchor" href="#页面布局"></a> 页面布局</h3>
<p>粗略版</p>
<p><img src="/img/2020/03/Chatroom/Layout01.png" alt="" /></p>
<h3 id="用户单聊"><a class="markdownIt-Anchor" href="#用户单聊"></a> 用户单聊</h3>
<p>前端页面在取得后台所返回的 Json 信息之后，根据信息初始化用户的聊天页面。</p>
<p><img src="/img/2020/03/Chatroom/UserInfoInit.PNG" alt="" /></p>
<blockquote>
<p>此程序不将聊天信息保存到数据库中，而是保存在前端的聊天页面用 Javascript 所自定义的一个数据结构里，一个<code>SentMessageMap(key, new Array())</code>。用户进行用户信息的初始化时要将此用户信息中的 groupId 以及 userId 作为键初始化这个聊天信息的 Map，以便后面进行聊天信息的保存。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setUserInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        type : <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        url : <span class="string">&#x27;chatroom/get_userinfo&#x27;</span>,</span><br><span class="line">        <span class="attr">dataType</span>: <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">        <span class="keyword">async</span> : <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;获取用户信息...&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (data.<span class="property">status</span> == <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="comment">// 自定义的数据结构，用于保存聊天信息进行回显</span></span><br><span class="line">                sentMessageMap = <span class="keyword">new</span> <span class="title class_">SentMessageMap</span>();</span><br><span class="line">                <span class="comment">// 获取用户信息</span></span><br><span class="line">                <span class="keyword">var</span> userInfo = data.<span class="property">data</span>.<span class="property">userInfo</span>;</span><br><span class="line">                userId = userInfo.<span class="property">userId</span>;</span><br><span class="line">                $(<span class="string">&quot;#username&quot;</span>).<span class="title function_">html</span>(userInfo.<span class="property">username</span>);</span><br><span class="line">                $(<span class="string">&quot;#avatarUrl&quot;</span>).<span class="title function_">attr</span>(<span class="string">&quot;src&quot;</span>, userInfo.<span class="property">avatarUrl</span>);</span><br><span class="line">                <span class="keyword">var</span> groupListHTML = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="comment">// 获取用户的群组信息</span></span><br><span class="line">                <span class="keyword">var</span> groupList = userInfo.<span class="property">groupList</span>;</span><br><span class="line">                <span class="comment">// 初始化群聊框列表</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; groupList.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                    <span class="comment">// 添加 Key</span></span><br><span class="line">                    sentMessageMap.<span class="title function_">put</span>(groupList[i].<span class="property">groupId</span>, <span class="keyword">new</span> <span class="title class_">Array</span>());</span><br><span class="line">                    groupListHTML +=</span><br><span class="line">                        <span class="string">&#x27;&lt;li&gt;&#x27;</span> + </span><br><span class="line">                        <span class="string">&#x27;&lt;div class=&quot;liLeft&quot;&gt;&lt;img src=&quot;&#x27;</span> + groupList[i].<span class="property">groupAvatarUrl</span> + <span class="string">&#x27;&quot;&gt;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">                        <span class="string">&#x27;&lt;div class=&quot;liRight&quot;&gt;&#x27;</span> +</span><br><span class="line">                        <span class="string">&#x27;&lt;span class=&quot;hidden-groupId&quot;&gt;&#x27;</span> + groupList[i].<span class="property">groupId</span> + <span class="string">&#x27;&lt;/span&gt;&#x27;</span> + </span><br><span class="line">                        <span class="string">&#x27;&lt;span class=&quot;intername&quot;&gt;&#x27;</span> + groupList[i].<span class="property">groupName</span> + <span class="string">&#x27;&lt;/span&gt;&#x27;</span> + </span><br><span class="line">                        <span class="string">&#x27;&lt;span class=&quot;infor&quot;&gt;&lt;/span&gt;&#x27;</span> + </span><br><span class="line">                        <span class="string">&#x27;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">                        <span class="string">&#x27;&lt;/li&gt;&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 添加群聊框列表</span></span><br><span class="line">                $(<span class="string">&#x27;.conLeft ul&#x27;</span>).<span class="title function_">append</span>(groupListHTML);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> friendListHTML = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="comment">// 获取用户好友信息</span></span><br><span class="line">                <span class="keyword">var</span> friendList = userInfo.<span class="property">friendList</span>;</span><br><span class="line">                <span class="comment">// 初始化好友框列表</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; friendList.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                    <span class="comment">// 添加 Key</span></span><br><span class="line">                    sentMessageMap.<span class="title function_">put</span>(friendList[i].<span class="property">userId</span>, <span class="keyword">new</span> <span class="title class_">Array</span>());</span><br><span class="line">                    friendListHTML +=</span><br><span class="line">                        <span class="string">&#x27;&lt;li&gt;&#x27;</span> + </span><br><span class="line">                        <span class="string">&#x27;&lt;div class=&quot;liLeft&quot;&gt;&lt;img src=&quot;&#x27;</span> + friendList[i].<span class="property">avatarUrl</span> + <span class="string">&#x27;&quot;&gt;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">                        <span class="string">&#x27;&lt;div class=&quot;liRight&quot;&gt;&#x27;</span> +</span><br><span class="line">                        <span class="string">&#x27;&lt;span class=&quot;hidden-userId&quot;&gt;&#x27;</span> + friendList[i].<span class="property">userId</span> + <span class="string">&#x27;&lt;/span&gt;&#x27;</span> + </span><br><span class="line">                        <span class="string">&#x27;&lt;span class=&quot;intername&quot;&gt;&#x27;</span> + friendList[i].<span class="property">username</span> + <span class="string">&#x27;&lt;/span&gt;&#x27;</span> + </span><br><span class="line">                        <span class="string">&#x27;&lt;span class=&quot;infor&quot;&gt;&lt;/span&gt;&#x27;</span> + </span><br><span class="line">                        <span class="string">&#x27;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">                        <span class="string">&#x27;&lt;/li&gt;&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 添加好友列表</span></span><br><span class="line">                $(<span class="string">&#x27;.conLeft ul&#x27;</span>).<span class="title function_">append</span>(friendListHTML);</span><br><span class="line">                <span class="comment">// 绑定好友框点击事件：显示右侧消息框</span></span><br><span class="line">                $(<span class="string">&#x27;.conLeft ul li&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, friendLiClickEvent);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">alert</span>(data.<span class="property">msg</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="单聊流程"><a class="markdownIt-Anchor" href="#单聊流程"></a> 单聊流程</h4>
<p><img src="/img/2020/03/Chatroom/SingleSend.PNG" alt="" /></p>
<h4 id="监听绑定"><a class="markdownIt-Anchor" href="#监听绑定"></a> 监听绑定</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="variable language_">window</span>.<span class="property">WebSocket</span>)&#123;  </span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">WebSocket</span> = <span class="variable language_">window</span>.<span class="property">MozWebSocket</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">WebSocket</span>)&#123;  </span><br><span class="line">    socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://localhost:3333&quot;</span>);  </span><br><span class="line">    socket.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params">event</span>)&#123;  </span><br><span class="line">        <span class="keyword">var</span> json = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(event.<span class="property">data</span>);    </span><br><span class="line">        <span class="keyword">if</span> (json.<span class="property">status</span> == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> type = json.<span class="property">data</span>.<span class="property">type</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;收到一条新信息，类型为：&quot;</span> + type);</span><br><span class="line">            <span class="keyword">switch</span>(type) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;REGISTER&quot;</span>:</span><br><span class="line">                    ws.<span class="title function_">registerReceive</span>();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;SINGLE_SENDING&quot;</span>:</span><br><span class="line">                    ws.<span class="title function_">singleReceive</span>(json.<span class="property">data</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="attr">default</span>:</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;不正确的类型！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">alert</span>(json.<span class="property">msg</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(json.<span class="property">msg</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接成功1秒后，将用户信息注册到服务器在线用户表</span></span><br><span class="line">    socket.<span class="property">onopen</span> = <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params">event</span>)&#123; </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;WebSocket已成功连接！&quot;</span>);  </span><br><span class="line">        ws.<span class="title function_">register</span>();</span><br><span class="line">    &#125;, <span class="number">1000</span>)  </span><br><span class="line"></span><br><span class="line">    socket.<span class="property">onclose</span> = <span class="keyword">function</span>(<span class="params">event</span>)&#123;  </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;WebSocket已关闭...&quot;</span>);  </span><br><span class="line">    &#125;;  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">&quot;您的浏览器不支持WebSocket！&quot;</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="websocket-处理"><a class="markdownIt-Anchor" href="#websocket-处理"></a> WebSocket 处理</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = &#123;</span><br><span class="line">    <span class="attr">register</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">WebSocket</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (socket.<span class="property">readyState</span> == <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> data = &#123;</span><br><span class="line">                <span class="string">&quot;userId&quot;</span> : userId,</span><br><span class="line">                <span class="string">&quot;type&quot;</span> : <span class="string">&quot;REGISTER&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line">            socket.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">alert</span>(<span class="string">&quot;Websocket连接没有开启！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">singleSend</span>: <span class="keyword">function</span>(<span class="params">fromUserId, toUserId, content</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">WebSocket</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (socket.<span class="property">readyState</span> == <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> data = &#123;</span><br><span class="line">                <span class="string">&quot;fromUserId&quot;</span> : fromUserId,</span><br><span class="line">                <span class="string">&quot;toUserId&quot;</span> : toUserId,</span><br><span class="line">                <span class="string">&quot;content&quot;</span> : content,</span><br><span class="line">                <span class="string">&quot;type&quot;</span> : <span class="string">&quot;SINGLE_SENDING&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// 将信息发送给客户端的 WebSocketServerhandler 进行处理</span></span><br><span class="line">            socket.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">alert</span>(<span class="string">&quot;Websocket连接没有开启！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">registerReceive</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;userId为 &quot;</span> + userId + <span class="string">&quot; 的用户登记到在线用户表成功！&quot;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">singleReceive</span>: <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取、构造参数</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">        <span class="keyword">var</span> fromUserId = data.<span class="property">fromUserId</span>;</span><br><span class="line">        <span class="keyword">var</span> content = data.<span class="property">content</span>;</span><br><span class="line">        <span class="keyword">var</span> fromAvatarUrl;</span><br><span class="line">        <span class="keyword">var</span> $receiveLi;</span><br><span class="line">        <span class="comment">// 为设置消息提醒以及获取头像取得元素</span></span><br><span class="line">        $(<span class="string">&#x27;.conLeft&#x27;</span>).<span class="title function_">find</span>(<span class="string">&#x27;span.hidden-userId&#x27;</span>).<span class="title function_">each</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">innerHTML</span> == fromUserId) &#123;</span><br><span class="line">                fromAvatarUrl = $(<span class="variable language_">this</span>).<span class="title function_">parent</span>(<span class="string">&quot;.liRight&quot;</span>)</span><br><span class="line">                    .<span class="title function_">siblings</span>(<span class="string">&quot;.liLeft&quot;</span>).<span class="title function_">children</span>(<span class="string">&#x27;img&#x27;</span>).<span class="title function_">attr</span>(<span class="string">&quot;src&quot;</span>);</span><br><span class="line">                $receiveLi = $(<span class="variable language_">this</span>).<span class="title function_">parent</span>(<span class="string">&quot;.liRight&quot;</span>).<span class="title function_">parent</span>(<span class="string">&quot;li&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">var</span> answer=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        answer += <span class="string">&#x27;&lt;li&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;div class=&quot;answers&quot;&gt;&#x27;</span>+ content +<span class="string">&#x27;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;div class=&quot;answerHead&quot;&gt;&lt;img src=&quot;&#x27;</span> + fromAvatarUrl + <span class="string">&#x27;&quot;/&gt;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;/li&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 消息框处理 放入暂存区，若用户正处于与新发消息用户的聊天窗口则回显（利用暂存区计算高度）</span></span><br><span class="line">        processMsgBox.<span class="title function_">receiveSingleMsg</span>(answer, fromUserId);</span><br><span class="line">        <span class="comment">// 好友列表处理 1.设置红色提醒标志 2.设置部分新消息提醒 3.置顶新消息</span></span><br><span class="line">        processFriendList.<span class="title function_">receiving</span>(content, $receiveLi);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="发送按钮"><a class="markdownIt-Anchor" href="#发送按钮"></a> 发送按钮</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&#x27;.sendBtn&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> fromUserId = userId;</span><br><span class="line">    <span class="keyword">var</span> toUserId = $(<span class="string">&#x27;#toUserId&#x27;</span>).<span class="title function_">val</span>();</span><br><span class="line">    <span class="keyword">var</span> toGroupId = $(<span class="string">&#x27;#toGroupId&#x27;</span>).<span class="title function_">val</span>();</span><br><span class="line">    <span class="keyword">var</span> news = $(<span class="string">&#x27;#dope&#x27;</span>).<span class="title function_">val</span>();</span><br><span class="line">    <span class="keyword">if</span> (toUserId == <span class="string">&#x27;&#x27;</span> &amp;&amp; toGroupId == <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&quot;请选择对话方&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(news == <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;消息不能为空&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (toUserId.<span class="property">length</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            ws.<span class="title function_">singleSend</span>(fromUserId, toUserId, news);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 群发</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $(<span class="string">&#x27;#dope&#x27;</span>).<span class="title function_">val</span>(<span class="string">&#x27;&#x27;</span>);			</span><br><span class="line">        <span class="keyword">var</span> avatarUrl = $(<span class="string">&#x27;#avatarUrl&#x27;</span>).<span class="title function_">attr</span>(<span class="string">&quot;src&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> msg = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        msg += <span class="string">&#x27;&lt;li&gt;&#x27;</span>+</span><br><span class="line">            <span class="string">&#x27;&lt;div class=&quot;news&quot;&gt;&#x27;</span> + news + <span class="string">&#x27;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;div class=&quot;nesHead&quot;&gt;&lt;img src=&quot;&#x27;</span> + avatarUrl + <span class="string">&#x27;&quot;/&gt;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;/li&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 消息框处理：</span></span><br><span class="line">        processMsgBox.<span class="title function_">sendMsg</span>(msg, toUserId, toGroupId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 好友列表处理：</span></span><br><span class="line">        <span class="keyword">var</span> $sendLi = $(<span class="string">&#x27;.conLeft&#x27;</span>).<span class="title function_">find</span>(<span class="string">&#x27;li.bg&#x27;</span>);</span><br><span class="line">        processFriendList.<span class="title function_">sending</span>(news, $sendLi);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="消息框处理"><a class="markdownIt-Anchor" href="#消息框处理"></a> 消息框处理</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sendMsg</span>: <span class="keyword">function</span>(<span class="params">msg, toUserId, toGroupId</span>) &#123;</span><br><span class="line">    <span class="comment">// 把内容添加到消息框</span></span><br><span class="line">    $(<span class="string">&#x27;.newsList&#x27;</span>).<span class="title function_">append</span>(msg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 手动计算、调整回显消息的宽度</span></span><br><span class="line">    <span class="keyword">var</span> $newsDiv = $(<span class="string">&#x27;.newsList li&#x27;</span>).<span class="title function_">last</span>().<span class="title function_">children</span>(<span class="string">&quot;div&quot;</span>).<span class="title function_">first</span>();</span><br><span class="line">    <span class="keyword">var</span> fixWidth = <span class="number">300</span>; <span class="comment">// 自定义的消息框本身的最长宽度</span></span><br><span class="line">    <span class="keyword">var</span> maxWidth = <span class="number">493</span>; <span class="comment">// 消息框所在行 div 的满宽度（不包含头像框的宽度部分）</span></span><br><span class="line">    <span class="keyword">var</span> minMarginLeftWidth = <span class="number">224</span>; <span class="comment">// 按理说应该是 maxwidth - fixWidth，这里出现了点问题</span></span><br><span class="line">    <span class="keyword">var</span> marginLeftWidth; <span class="comment">// 要计算消息框的margin-left宽度</span></span><br><span class="line">    <span class="keyword">if</span> ($newsDiv.<span class="title function_">actual</span>(<span class="string">&#x27;width&#x27;</span>) &lt; fixWidth) &#123;</span><br><span class="line">        marginLeftWidth = maxWidth - $newsDiv.<span class="title function_">actual</span>(<span class="string">&#x27;width&#x27;</span>);</span><br><span class="line">        $newsDiv.<span class="title function_">css</span>(<span class="string">&quot;margin-left&quot;</span>, marginLeftWidth + <span class="string">&quot;px&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $newsDiv.<span class="title function_">css</span>(<span class="string">&quot;width&quot;</span>, fixWidth + <span class="string">&quot;px&quot;</span>)</span><br><span class="line">            .<span class="title function_">css</span>(<span class="string">&quot;margin-left&quot;</span>, minMarginLeftWidth + <span class="string">&quot;px&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 把 调整后的消息html标签字符串 添加到已发送用户消息表</span></span><br><span class="line">    <span class="keyword">if</span> (toUserId.<span class="property">length</span> != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 得到数组添加新消息 以 outerHTML 的形式</span></span><br><span class="line">        <span class="comment">// last() 得到匹配元素的最后一个</span></span><br><span class="line">        sentMessageMap.<span class="title function_">get</span>(toUserId).<span class="title function_">push</span>($(<span class="string">&#x27;.newsList li&#x27;</span>).<span class="title function_">last</span>().<span class="title function_">prop</span>(<span class="string">&quot;outerHTML&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sentMessageMap.<span class="title function_">get</span>(toGroupId).<span class="title function_">push</span>($(<span class="string">&#x27;.newsList li&#x27;</span>).<span class="title function_">last</span>().<span class="title function_">prop</span>(<span class="string">&quot;outerHTML&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 滚动条往底部移</span></span><br><span class="line">    $(<span class="string">&#x27;.RightCont&#x27;</span>).<span class="title function_">scrollTop</span>($(<span class="string">&#x27;.RightCont&#x27;</span>)[<span class="number">0</span>].<span class="property">scrollHeight</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="好友列表处理"><a class="markdownIt-Anchor" href="#好友列表处理"></a> 好友列表处理</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sending</span>: <span class="keyword">function</span>(<span class="params">content, $sendLi</span>) &#123;</span><br><span class="line">    <span class="comment">// 设置部分新消息提醒</span></span><br><span class="line">    <span class="keyword">if</span> (content.<span class="property">length</span> &gt; <span class="number">8</span>) &#123;</span><br><span class="line">        content = content.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">8</span>) + <span class="string">&quot;...&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $(<span class="string">&#x27;.conLeft&#x27;</span>).<span class="title function_">find</span>(<span class="string">&#x27;li.bg&#x27;</span>).<span class="title function_">children</span>(<span class="string">&#x27;.liRight&#x27;</span>).<span class="title function_">children</span>(<span class="string">&#x27;.infor&#x27;</span>).<span class="title function_">text</span>(content);</span><br><span class="line">    <span class="comment">// 如果存在新消息提醒徽章，则去除徽章</span></span><br><span class="line">    <span class="keyword">if</span> ($sendLi.<span class="title function_">find</span>(<span class="string">&#x27;.layui-badge&#x27;</span>).<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        $sendLi.<span class="title function_">find</span>(<span class="string">&#x27;.layui-badge&#x27;</span>).<span class="title function_">remove</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//$(&#x27;.conLeft ul&#x27;).prepend(&#x27;&lt;li class=&quot;bg&quot;&gt;&#x27; + $sendLi.html() + &#x27;&lt;/li&gt;&#x27;);</span></span><br><span class="line">    <span class="comment">// 好友框新消息置顶</span></span><br><span class="line">    $(<span class="string">&#x27;.conLeft ul&#x27;</span>).<span class="title function_">prepend</span>($sendLi.<span class="title function_">prop</span>(<span class="string">&quot;outerHTML&quot;</span>));</span><br><span class="line">    $sendLi.<span class="title function_">remove</span>();</span><br><span class="line">    $(<span class="string">&#x27;.conLeft ul li&#x27;</span>).<span class="title function_">first</span>().<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, friendLiClickEvent)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="服务器处理"><a class="markdownIt-Anchor" href="#服务器处理"></a> 服务器处理</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">singleSend</span><span class="params">(JSONObject param, ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fromUserId</span> <span class="operator">=</span> String.valueOf(param.get(<span class="string">&quot;fromUserId&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">toUserId</span> <span class="operator">=</span> (String)param.get(<span class="string">&quot;toUserId&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> (String)param.get(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">    <span class="comment">// 取得接收者的通道</span></span><br><span class="line">    <span class="type">ChannelHandlerContext</span> <span class="variable">toUserCtx</span> <span class="operator">=</span> Constant.onlineUserMap.get(toUserId);</span><br><span class="line">    <span class="keyword">if</span> (toUserCtx == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseJson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>()</span><br><span class="line">            .error(MessageFormat.format(<span class="string">&quot;userId为 &#123;0&#125; 的用户没有登录！&quot;</span>, toUserId))</span><br><span class="line">            .toString();</span><br><span class="line">        sendMessage(ctx, responseJson);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseJson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>().success()</span><br><span class="line">            .setData(<span class="string">&quot;fromUserId&quot;</span>, fromUserId)</span><br><span class="line">            .setData(<span class="string">&quot;content&quot;</span>, content)</span><br><span class="line">            .setData(<span class="string">&quot;type&quot;</span>, ChatType.SINGLE_SENDING)</span><br><span class="line">            .toString();</span><br><span class="line">        <span class="comment">// 发送消息给接收者的通道，浏览器 socket 监听处理</span></span><br><span class="line">        sendMessage(toUserCtx, responseJson);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="测试"><a class="markdownIt-Anchor" href="#测试"></a> 测试</h4>
<p><img src="/img/2020/03/Chatroom/Test02.PNG" alt="" /></p>
<p>通过控制台调试可以取得 sentMessageMap 中保存了与 userId=2 的用户的聊天信息数组。</p>
<p><img src="/img/2020/03/Chatroom/Test03.PNG" alt="" /></p>
<p><img src="/img/2020/03/Chatroom/Test01.PNG" alt="" /></p>
<p>通过控制台调试可以取得 sentMessageMap 中保存了与 userId=1 的用户的聊天信息数组。</p>
<p><img src="/img/2020/03/Chatroom/Test04.PNG" alt="" /></p>
<h3 id="群组聊天"><a class="markdownIt-Anchor" href="#群组聊天"></a> 群组聊天</h3>
<p>群组聊天的流程与用户单聊流程基本相似，只是在给接收者的通道发送消息时需要通过群组信息取得群组里的成员的信息，并获取成员的所有通道进行消息的遍发送。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">groupSend</span><span class="params">(JSONObject param, ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">fromUserId</span> <span class="operator">=</span> String.valueOf(param.get(<span class="string">&quot;fromUserId&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">toGroupId</span> <span class="operator">=</span> (String)param.get(<span class="string">&quot;toGroupId&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> (String)param.get(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">    <span class="type">Chatgroup</span> <span class="variable">chatgroup</span> <span class="operator">=</span> groupDao.getByGroupId(toGroupId);</span><br><span class="line">    <span class="keyword">if</span> (chatgroup == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseJson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>().error(<span class="string">&quot;该群id不存在&quot;</span>).toString();</span><br><span class="line">        sendMessage(ctx, responseJson);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        List&lt;String&gt; groupUsersId = userChatRelationDao.getUsersIdByGroupId(toGroupId);</span><br><span class="line">        List&lt;User&gt; groupUser = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;User&gt;();</span><br><span class="line">        <span class="keyword">for</span>(String groupUserId : groupUsersId)&#123;</span><br><span class="line">            groupUser.add(userDao.getByUserId(groupUserId));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">GroupInfo</span> <span class="variable">groupInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroupInfo</span>(</span><br><span class="line">            chatgroup.getGroupId(),</span><br><span class="line">            chatgroup.getGroupName(),</span><br><span class="line">            chatgroup.getGroupAvatarUrl(),</span><br><span class="line">            groupUser</span><br><span class="line">        );</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseJson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>().success()</span><br><span class="line">            .setData(<span class="string">&quot;fromUserId&quot;</span>, fromUserId)</span><br><span class="line">            .setData(<span class="string">&quot;content&quot;</span>, content)</span><br><span class="line">            .setData(<span class="string">&quot;toGroupId&quot;</span>, toGroupId)</span><br><span class="line">            .setData(<span class="string">&quot;type&quot;</span>, ChatType.GROUP_SENDING)</span><br><span class="line">            .toString();</span><br><span class="line">        groupInfo.getMembers()</span><br><span class="line">            .forEach(member -&gt; &#123;</span><br><span class="line">                <span class="type">ChannelHandlerContext</span> <span class="variable">toCtx</span> <span class="operator">=</span> Constant.onlineUserMap.get(String.valueOf(member.getUserId()));</span><br><span class="line">                <span class="keyword">if</span> (toCtx != <span class="literal">null</span> &amp;&amp; !String.valueOf(member.getUserId()).equals(fromUserId)) &#123;</span><br><span class="line">                    sendMessage(toCtx, responseJson);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接收消息者则根据 groupId 来显示接收到的消息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groupReceive</span>: <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取、构造参数</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">    <span class="keyword">var</span> fromUserId = data.<span class="property">fromUserId</span>;</span><br><span class="line">    <span class="keyword">var</span> content = data.<span class="property">content</span>;</span><br><span class="line">    <span class="keyword">var</span> toGroupId = data.<span class="property">toGroupId</span>;</span><br><span class="line">    <span class="keyword">var</span> fromAvatarUrl;</span><br><span class="line">    <span class="keyword">var</span> $receiveLi;</span><br><span class="line">    $(<span class="string">&#x27;.conLeft&#x27;</span>).<span class="title function_">find</span>(<span class="string">&#x27;span.hidden-userId&#x27;</span>).<span class="title function_">each</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">innerHTML</span> == fromUserId) &#123;</span><br><span class="line">            fromAvatarUrl = $(<span class="variable language_">this</span>).<span class="title function_">parent</span>(<span class="string">&quot;.liRight&quot;</span>)</span><br><span class="line">                .<span class="title function_">siblings</span>(<span class="string">&quot;.liLeft&quot;</span>).<span class="title function_">children</span>(<span class="string">&#x27;img&#x27;</span>).<span class="title function_">attr</span>(<span class="string">&quot;src&quot;</span>);</span><br><span class="line">            <span class="comment">/* $receiveLi = $(this).parent(&quot;.liRight&quot;).parent(&quot;li&quot;); */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    $(<span class="string">&#x27;.conLeft&#x27;</span>).<span class="title function_">find</span>(<span class="string">&#x27;span.hidden-groupId&#x27;</span>).<span class="title function_">each</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// 群组聊天框</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">innerHTML</span> == toGroupId) &#123;</span><br><span class="line">            $receiveLi = $(<span class="variable language_">this</span>).<span class="title function_">parent</span>(<span class="string">&quot;.liRight&quot;</span>).<span class="title function_">parent</span>(<span class="string">&quot;li&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">var</span> answer=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    answer += <span class="string">&#x27;&lt;li&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;div class=&quot;answers&quot;&gt;&#x27;</span>+ content +<span class="string">&#x27;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;div class=&quot;answerHead&quot;&gt;&lt;img src=&quot;&#x27;</span> + fromAvatarUrl + <span class="string">&#x27;&quot;/&gt;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;/li&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息框处理   </span></span><br><span class="line">    processMsgBox.<span class="title function_">receiveGroupMsg</span>(answer, toGroupId);</span><br><span class="line">    <span class="comment">// 好友列表处理</span></span><br><span class="line">    processFriendList.<span class="title function_">receiving</span>(content, $receiveLi);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h3 id="发送表情"><a class="markdownIt-Anchor" href="#发送表情"></a> 发送表情</h3>
<p>表情的发送的底层原理和发送文字是一样的，只是发送表情的话，发送内容是一串静态资源的 URI。</p>
<p>表情模块绑定的监听事件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&#x27;.ExP&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;mouseenter&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    $(<span class="string">&#x27;.emjon&#x27;</span>).<span class="title function_">show</span>();</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;.emjon&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;mouseleave&#x27;</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    $(<span class="string">&#x27;.emjon&#x27;</span>).<span class="title function_">hide</span>();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="发送文件"><a class="markdownIt-Anchor" href="#发送文件"></a> 发送文件</h3>
<p>文件的上传使用的是 commons-fileupload 工具类。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 文件上传 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-fileupload<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>文件上传的模态框表格：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;modal-body&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">&quot;form-horizontal&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-3 control-label&quot;</span>&gt;</span>选择文件<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-9&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">class</span>=<span class="string">&quot;col-sm-9 myfile&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;help-block&quot;</span>&gt;</span>注意：文件大小不超过30M，有效期为7天<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Bootstrap 的文件上传控件 bootstrap-fileinput 的使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&quot;.myfile&quot;</span>).<span class="title function_">fileinput</span>(&#123;</span><br><span class="line">    <span class="attr">uploadUrl</span>:<span class="string">&quot;chatroom/upload&quot;</span>,</span><br><span class="line">    uploadAsync : <span class="literal">true</span>, <span class="comment">// 默认异步上传</span></span><br><span class="line">    showUpload : <span class="literal">true</span>, <span class="comment">// 是否显示上传按钮</span></span><br><span class="line">    showRemove : <span class="literal">false</span>, <span class="comment">// 显示移除按钮</span></span><br><span class="line">    showCaption : <span class="literal">false</span>, <span class="comment">// 是否显示标题</span></span><br><span class="line">    showPreview : <span class="literal">true</span>, <span class="comment">// 是否显示预览，默认为 true</span></span><br><span class="line">    <span class="attr">dropZoneTitle</span>: <span class="string">&quot;请通过拖拽图片文件放到这里&quot;</span>,</span><br><span class="line">    dropZoneEnabled : <span class="literal">false</span>, <span class="comment">// 是否显示拖拽区域，默认不写为 true，但是会占用很大区域</span></span><br><span class="line">    <span class="attr">maxFileSize</span>: <span class="number">30720</span>, <span class="comment">// 单位为 kb，如果为 0 表示不限制文件大小</span></span><br><span class="line">    maxFileCount : <span class="number">1</span>,  <span class="comment">// 表示允许同时上传的最大文件个数</span></span><br><span class="line">    enctype : <span class="string">&#x27;multipart/form-data&#x27;</span>,</span><br><span class="line">    validateInitialCount : <span class="literal">true</span>,</span><br><span class="line">    previewFileIcon : <span class="string">&quot;&lt;i class=&#x27;glyphicon glyphicon-file&#x27;&gt;&lt;/i&gt;&quot;</span>,</span><br><span class="line">    msgFilesTooMany : <span class="string">&quot;选择上传的文件数量(&#123;n&#125;) 超过允许的最大数值&#123;m&#125;！&quot;</span>,</span><br><span class="line">    language : <span class="string">&#x27;zh&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 异步上传返回文件上传错误结果处理</span></span><br><span class="line">$(<span class="string">&#x27;.myfile&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;fileerror&#x27;</span>, <span class="keyword">function</span>(<span class="params">event, data, msg</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fileerror&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 异步上传返回结果处理</span></span><br><span class="line">$(<span class="string">&quot;.myfile&quot;</span>).<span class="title function_">on</span>(<span class="string">&quot;fileuploaded&quot;</span>, <span class="keyword">function</span>(<span class="params">event, data, previewId, index</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 上传成功1.5秒后自动关闭上传模态框</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fileuploaded&quot;</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        $(<span class="string">&#x27;#upload-cancel&#x27;</span>).<span class="title function_">trigger</span>(<span class="string">&#x27;click&#x27;</span>);</span><br><span class="line">        $(<span class="string">&#x27;.fileinput-remove&#x27;</span>).<span class="title function_">trigger</span>(<span class="string">&#x27;click&#x27;</span>);</span><br><span class="line">    &#125;, <span class="number">1500</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 获取、设置参数</span></span><br><span class="line">    <span class="keyword">var</span> returnData = data.<span class="property">response</span>.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">var</span> originalFilename = returnData.<span class="property">originalFilename</span>;</span><br><span class="line">    <span class="keyword">var</span> fileSize = returnData.<span class="property">fileSize</span>;</span><br><span class="line">    <span class="keyword">var</span> fileUrl = returnData.<span class="property">fileUrl</span>;</span><br><span class="line">    <span class="keyword">var</span> content = <span class="string">&quot;[文件]&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> fromUserId = userId;</span><br><span class="line">    <span class="keyword">var</span> avatarUrl = $(<span class="string">&#x27;#avatarUrl&#x27;</span>).<span class="title function_">attr</span>(<span class="string">&quot;src&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> $sendLi = $(<span class="string">&#x27;.conLeft&#x27;</span>).<span class="title function_">find</span>(<span class="string">&#x27;li.bg&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> toUserId = $(<span class="string">&#x27;#toUserId&#x27;</span>).<span class="title function_">val</span>();</span><br><span class="line">    <span class="keyword">var</span> toGroupId = $(<span class="string">&#x27;#toGroupId&#x27;</span>).<span class="title function_">val</span>();</span><br><span class="line">    <span class="comment">// 拼接发送者对话框的消息</span></span><br><span class="line">    <span class="keyword">var</span> fileHtml = </span><br><span class="line">        <span class="string">&#x27;&lt;li&gt;&#x27;</span>+</span><br><span class="line">        <span class="string">&#x27;&lt;div class=&quot;send-file-shown&quot;&gt;&#x27;</span> + </span><br><span class="line">        <span class="string">&#x27;&lt;div class=&quot;media&quot;&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;a href=&quot;&#x27;</span> + fileUrl + <span class="string">&#x27;&quot; class=&quot;media-left&quot;&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;i class=&quot;glyphicon glyphicon-file&quot; style=&quot;font-size:28pt;&quot;&gt;&lt;/i&gt;&#x27;</span> + </span><br><span class="line">        <span class="string">&#x27;&lt;/a&gt;&#x27;</span> + </span><br><span class="line">        <span class="string">&#x27;&lt;div class=&quot;media-body&quot;&gt; &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;h5 class=&quot;media-heading&quot;&gt;&#x27;</span> + originalFilename + <span class="string">&#x27;&lt;/h5&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;span&gt;&#x27;</span>+ fileSize + <span class="string">&#x27;&lt;/span&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;/div&gt;&#x27;</span>+</span><br><span class="line">        <span class="string">&#x27;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;div class=&quot;nesHead&quot;&gt;&lt;img src=&quot;&#x27;</span> + avatarUrl + <span class="string">&#x27;&quot;/&gt;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;/li&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 发送信息到服务器        </span></span><br><span class="line">    <span class="keyword">if</span> (toUserId.<span class="property">length</span> != <span class="number">0</span>) &#123;</span><br><span class="line">        ws.<span class="title function_">fileMsgSingleSend</span>(fromUserId, toUserId, originalFilename, fileUrl, fileSize);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ws.<span class="title function_">fileMsgGroupSend</span>(fromUserId, toGroupId, originalFilename, fileUrl, fileSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 消息框处理： </span></span><br><span class="line">    processMsgBox.<span class="title function_">sendFileMsg</span>(fileHtml, toUserId, toGroupId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 好友列表处理</span></span><br><span class="line">    processFriendList.<span class="title function_">sending</span>(content, $sendLi);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//上传前</span></span><br><span class="line">$(<span class="string">&#x27;.myfile&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;filepreupload&#x27;</span>, <span class="keyword">function</span>(<span class="params">event, data, previewId, index</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;filepreupload&quot;</span>);</span><br><span class="line">&#125;);	</span><br></pre></td></tr></table></figure>
<p>文件上传的控制器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/upload&quot;, method = POST)</span></span><br><span class="line"><span class="meta">@ResponseBody</span> </span><br><span class="line"><span class="keyword">public</span> ResponseJson <span class="title function_">upload</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@RequestParam(value = &quot;file&quot;, required = true)</span>  file, HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fileUploadService.upload(file, request);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>文件上传的业务逻辑处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">FileUploadService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 项目的打包目录，本项目打包在根目录下</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">SERVER_URL_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8080/&quot;</span>;</span><br><span class="line">    <span class="comment">// 保存上传文件的文件夹名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">FILE_STORE_PATH</span> <span class="operator">=</span> <span class="string">&quot;UploadFile&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ResponseJson <span class="title function_">upload</span><span class="params">(MultipartFile file, HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// 重命名文件，防止重名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> getRandomUUID();</span><br><span class="line">        <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileSize</span> <span class="operator">=</span> FileUtils.getFormatSize(file.getSize());</span><br><span class="line">        <span class="comment">// 截取文件的后缀名</span></span><br><span class="line">        <span class="keyword">if</span> (originalFilename.contains(<span class="string">&quot;.&quot;</span>)) &#123;</span><br><span class="line">            suffix = originalFilename.substring(originalFilename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        filename = filename + suffix;</span><br><span class="line">        <span class="comment">// getRealPath(“/”) 获取实际路径,“/”指代项目根目录,所以代码返回的是项目在容器中的实际发布运行的根路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> request.getSession().getServletContext().getRealPath(<span class="string">&quot;/&quot;</span>) + FILE_STORE_PATH;</span><br><span class="line">        System.out.println(<span class="string">&quot;存储路径为:&quot;</span> + prefix + <span class="string">&quot;\\&quot;</span> + filename);</span><br><span class="line">        <span class="type">Path</span> <span class="variable">filePath</span> <span class="operator">=</span> Paths.get(prefix, filename);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Files.copy(file.getInputStream(), filePath);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>().error(<span class="string">&quot;文件上传发生错误！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>().success()</span><br><span class="line">            .setData(<span class="string">&quot;originalFilename&quot;</span>, originalFilename)</span><br><span class="line">            .setData(<span class="string">&quot;fileSize&quot;</span>, fileSize)</span><br><span class="line">            .setData(<span class="string">&quot;fileUrl&quot;</span>, SERVER_URL_PREFIX + FILE_STORE_PATH + <span class="string">&quot;\\&quot;</span> + filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getRandomUUID</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WebSoclet 处理文件发送方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">FileMsgSingleSend</span><span class="params">(JSONObject param, ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fromUserId</span> <span class="operator">=</span> String.valueOf(param.get(<span class="string">&quot;fromUserId&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">toUserId</span> <span class="operator">=</span> (String)param.get(<span class="string">&quot;toUserId&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> (String)param.get(<span class="string">&quot;originalFilename&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileSize</span> <span class="operator">=</span> (String)param.get(<span class="string">&quot;fileSize&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileUrl</span> <span class="operator">=</span> (String)param.get(<span class="string">&quot;fileUrl&quot;</span>);</span><br><span class="line">    <span class="type">ChannelHandlerContext</span> <span class="variable">toUserCtx</span> <span class="operator">=</span> Constant.onlineUserMap.get(toUserId);</span><br><span class="line">    <span class="keyword">if</span> (toUserCtx == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseJson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>()</span><br><span class="line">            .error(MessageFormat.format(<span class="string">&quot;userId为 &#123;0&#125; 的用户没有登录！&quot;</span>, toUserId))</span><br><span class="line">            .toString();</span><br><span class="line">        sendMessage(ctx, responseJson);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseJson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseJson</span>().success()</span><br><span class="line">            .setData(<span class="string">&quot;fromUserId&quot;</span>, fromUserId)</span><br><span class="line">            .setData(<span class="string">&quot;originalFilename&quot;</span>, originalFilename)</span><br><span class="line">            .setData(<span class="string">&quot;fileSize&quot;</span>, fileSize)</span><br><span class="line">            .setData(<span class="string">&quot;fileUrl&quot;</span>, fileUrl)</span><br><span class="line">            .setData(<span class="string">&quot;type&quot;</span>, ChatType.FILE_MSG_SINGLE_SENDING)</span><br><span class="line">            .toString();</span><br><span class="line">        sendMessage(toUserCtx, responseJson);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 群发文件则与群组聊天类似，取群组中的用户的通道遍历发送文件信息</span></span><br></pre></td></tr></table></figure>
<p>接收者对话框接收文件消息的拼接：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">fileMsgSingleRecieve</span>: <span class="keyword">function</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取、构造参数</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">    <span class="keyword">var</span> fromUserId = data.<span class="property">fromUserId</span>;</span><br><span class="line">    <span class="keyword">var</span> originalFilename = data.<span class="property">originalFilename</span>;</span><br><span class="line">    <span class="keyword">var</span> fileSize = data.<span class="property">fileSize</span>;</span><br><span class="line">    <span class="keyword">var</span> fileUrl = data.<span class="property">fileUrl</span>;</span><br><span class="line">    <span class="keyword">var</span> content = <span class="string">&quot;[文件]&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> fromAvatarUrl;</span><br><span class="line">    <span class="keyword">var</span> $receiveLi;</span><br><span class="line">    $(<span class="string">&#x27;.conLeft&#x27;</span>).<span class="title function_">find</span>(<span class="string">&#x27;span.hidden-userId&#x27;</span>).<span class="title function_">each</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">innerHTML</span> == fromUserId) &#123;</span><br><span class="line">            fromAvatarUrl = $(<span class="variable language_">this</span>).<span class="title function_">parent</span>(<span class="string">&quot;.liRight&quot;</span>)</span><br><span class="line">                .<span class="title function_">siblings</span>(<span class="string">&quot;.liLeft&quot;</span>).<span class="title function_">children</span>(<span class="string">&#x27;img&#x27;</span>).<span class="title function_">attr</span>(<span class="string">&quot;src&quot;</span>);</span><br><span class="line">            $receiveLi = $(<span class="variable language_">this</span>).<span class="title function_">parent</span>(<span class="string">&quot;.liRight&quot;</span>).<span class="title function_">parent</span>(<span class="string">&quot;li&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">var</span> fileHtml = </span><br><span class="line">        <span class="string">&#x27;&lt;li&gt;&#x27;</span>+</span><br><span class="line">        <span class="string">&#x27;&lt;div class=&quot;receive-file-shown&quot;&gt;&#x27;</span> + </span><br><span class="line">        <span class="string">&#x27;&lt;div class=&quot;media&quot;&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;div class=&quot;media-body&quot;&gt; &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;h5 class=&quot;media-heading&quot;&gt;&#x27;</span> + originalFilename + <span class="string">&#x27;&lt;/h5&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;span&gt;&#x27;</span>+ fileSize + <span class="string">&#x27;&lt;/span&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;a href=&quot;&#x27;</span> + fileUrl + <span class="string">&#x27;&quot; class=&quot;media-right&quot;&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;i class=&quot;glyphicon glyphicon-file&quot; style=&quot;font-size:28pt;&quot;&gt;&lt;/i&gt;&#x27;</span> + </span><br><span class="line">        <span class="string">&#x27;&lt;/a&gt;&#x27;</span> + </span><br><span class="line">        <span class="string">&#x27;&lt;/div&gt;&#x27;</span>+</span><br><span class="line">        <span class="string">&#x27;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;div class=&quot;answerHead&quot;&gt;&lt;img src=&quot;&#x27;</span> + fromAvatarUrl + <span class="string">&#x27;&quot;/&gt;&lt;/div&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;/li&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息框处理     </span></span><br><span class="line">    processMsgBox.<span class="title function_">receiveSingleMsg</span>(fileHtml, fromUserId);</span><br><span class="line">    <span class="comment">// 好友列表处理</span></span><br><span class="line">    processFriendList.<span class="title function_">receiving</span>(content, $receiveLi);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

      
    </div>
    <!-- <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://wingowen.github.io/2020/01/31/%E5%90%8E%E5%8F%B0%E6%8A%80%E6%9C%AF/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/%E8%81%8A%E5%A4%A9%E5%AE%A4%E9%A1%B9%E7%9B%AE/" title="Chatroom 简介" target="_blank" rel="external">https://wingowen.github.io/2020/01/31/后台技术/项目开发/聊天室项目/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">WINGO.WEN</span><small class="ml-1x"></small></a></h3>
        <div>一个疯子。</div>
      </div>
    </figure>
  </div>
</div>


    </div> -->
  </article>
  
    
  <section id="comments">
  	
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2020/02/15/%E8%BF%90%E7%BB%B4/Git%20%E5%91%BD%E4%BB%A4%E6%B8%85%E5%8D%95/" title="Git 命令清单"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2020/01/26/%E5%90%8E%E5%8F%B0%E6%8A%80%E6%9C%AF/Netty/Netty%20%E5%BC%95%E5%AF%BC/" title="Netty 引导"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">    <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
    <div class="copyright">
    	
        <div class="publishby">
        	<!-- Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>. -->
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   






</body>
</html>